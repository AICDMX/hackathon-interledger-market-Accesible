{% load i18n static %}
{% comment %}
Audio player template component.
Usage: {% audio_player content_object "title" "en" %}
{% endcomment %}

<div class="audio-player-wrapper" 
     data-audio-target="{{ target_field }}"
     data-content-type="{{ content_type_id }}"
     data-object-id="{{ object_id }}"
     data-language="{{ language_code }}">
    
    {% if audio_snippet and audio_snippet.file %}
        {# Audio available - show player #}
        <button class="audio-play-btn" 
                aria-label="{% blocktrans with field=target_field lang=language_code %}Play audio for {{ field }} in {{ lang }}{% endblocktrans %}"
                onclick="playAudio(this)">
            <img src="/media/listen.png" alt="{% trans 'Listen' %}" class="audio-icon" aria-hidden="true">
        </button>
        
        <div class="audio-player-container" style="display: none;">
            <audio controls 
                   preload="none"
                   aria-label="{% blocktrans with field=target_field lang=language_code %}Audio player for {{ field }} in {{ lang }}{% endblocktrans %}">
                <source src="{{ audio_snippet.file.url }}" type="audio/mpeg">
                <source src="{{ audio_snippet.file.url }}" type="audio/ogg">
                {% trans "Your browser does not support the audio element." %}
            </audio>
            <button class="audio-close-btn" onclick="closeAudioPlayer(this)" aria-label="{% trans 'Close audio player' %}">?</button>
        </div>
    {% else %}
        {# Audio not available - try fallback #}
        {% if fallback_audio_url %}
            <button class="audio-play-btn audio-fallback-btn" 
                    aria-label="{% blocktrans with field=target_field lang=language_code %}Play fallback audio for {{ field }} in {{ lang }}{% endblocktrans %}"
                    onclick="playAudio(this)">
                <img src="/media/listen.png" alt="{% trans 'Listen (Fallback)' %}" class="audio-icon" aria-hidden="true">
            </button>
            
            <div class="audio-player-container" style="display: none;">
                <audio controls 
                       preload="none"
                       data-fallback="true"
                       aria-label="{% blocktrans with field=target_field lang=language_code %}Fallback audio player for {{ field }} in {{ lang }}{% endblocktrans %}">
                    <source src="{{ fallback_audio_url }}" type="audio/mpeg">
                    <source src="{{ fallback_audio_url }}" type="audio/ogg">
                    {% trans "Your browser does not support the audio element." %}
                </audio>
                <button class="audio-close-btn" onclick="closeAudioPlayer(this)" aria-label="{% trans 'Close audio player' %}">?</button>
            </div>
        {% else %}
            {# No fallback - show request button #}
            <button class="audio-request-btn" 
                    aria-label="{% blocktrans with field=target_field lang=language_code %}Request audio for {{ field }} in {{ lang }}{% endblocktrans %}"
                    onclick="requestAudio(this)">
                <img src="/media/listen.png" alt="{% trans 'Request audio' %}" class="audio-icon" aria-hidden="true">
            </button>
            
            <div class="audio-request-message" style="display: none;" role="alert"></div>
        {% endif %}
    {% endif %}
</div>

<script>
// Audio player functionality
function playAudio(button) {
    const wrapper = button.closest('.audio-player-wrapper');
    const playerContainer = wrapper.querySelector('.audio-player-container');
    const audio = playerContainer.querySelector('audio');
    
    // Hide button, show player
    button.style.display = 'none';
    playerContainer.style.display = 'block';
    
    // Play audio
    audio.play().catch(err => {
        console.error('Error playing audio:', err);
        // Show error message
        const errorMsg = document.createElement('div');
        errorMsg.className = 'audio-error';
        errorMsg.textContent = '{% trans "Error loading audio. Please try again." %}';
        playerContainer.appendChild(errorMsg);
    });
}

function closeAudioPlayer(button) {
    const container = button.closest('.audio-player-container');
    const wrapper = container.closest('.audio-player-wrapper');
    const playBtn = wrapper.querySelector('.audio-play-btn');
    const audio = container.querySelector('audio');
    
    // Stop audio
    audio.pause();
    audio.currentTime = 0;
    
    // Hide player, show button
    container.style.display = 'none';
    playBtn.style.display = 'inline-flex';
}

function requestAudio(button) {
    const wrapper = button.closest('.audio-player-wrapper');
    const languageCode = wrapper.dataset.language || '{{ preferred_audio_language|default:LANGUAGE_CODE }}';
    
    // Instead of requesting, play fallback audio
    playFallbackAudio(button, languageCode);
}

function playFallbackAudio(button, languageCode) {
    const wrapper = button.closest('.audio-player-wrapper');
    
    // Get fallback audio URL based on language
    // Language-specific fallbacks: oto -> fallback-oto.mp3, others -> fallback.mp3
    let fallbackPath = '{% static "audio/fallback.mp3" %}';
    if (languageCode === 'oto') {
        fallbackPath = '{% static "audio/fallback-oto.mp3" %}';
    }
    
    // Create audio element and play
    const audio = new Audio(fallbackPath);
    const playerContainer = document.createElement('div');
    playerContainer.className = 'audio-player-container';
    playerContainer.style.display = 'block';
    
    const audioElement = document.createElement('audio');
    audioElement.controls = true;
    audioElement.preload = 'none';
    audioElement.setAttribute('aria-label', '{% trans "Fallback audio player" %}');
    const source = document.createElement('source');
    source.src = fallbackPath;
    source.type = 'audio/mpeg';
    audioElement.appendChild(source);
    
    const closeBtn = document.createElement('button');
    closeBtn.className = 'audio-close-btn';
    closeBtn.setAttribute('aria-label', '{% trans "Close audio player" %}');
    closeBtn.textContent = '?';
    closeBtn.onclick = function() {
        audio.pause();
        audio.currentTime = 0;
        playerContainer.remove();
        button.style.display = 'inline-flex';
    };
    
    playerContainer.appendChild(audioElement);
    playerContainer.appendChild(closeBtn);
    
    // Hide button, show player
    button.style.display = 'none';
    wrapper.appendChild(playerContainer);
    
    // Play audio
    audio.play().catch(err => {
        console.error('Error playing fallback audio:', err);
        // Try generic fallback if language-specific fails
        if (languageCode === 'oto') {
            const genericFallback = new Audio('{% static "audio/fallback.mp3" %}');
            genericFallback.play().catch(() => {
                const errorMsg = document.createElement('div');
                errorMsg.className = 'audio-error';
                errorMsg.textContent = '{% trans "Error loading audio. Please try again." %}';
                playerContainer.appendChild(errorMsg);
            });
        } else {
            const errorMsg = document.createElement('div');
            errorMsg.className = 'audio-error';
            errorMsg.textContent = '{% trans "Error loading audio. Please try again." %}';
            playerContainer.appendChild(errorMsg);
        }
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

<style>
.audio-player-wrapper {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    margin-left: 0.5rem;
}

.audio-play-btn,
.audio-request-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.25rem;
    background-color: transparent;
    border: none;
    cursor: pointer;
    transition: opacity 0.2s;
    min-width: 32px;
    min-height: 32px;
}

.audio-play-btn *,
.audio-request-btn * {
    pointer-events: none;
}

.audio-play-btn .audio-label,
.audio-request-btn .audio-label,
.audio-play-btn span:not(.audio-icon),
.audio-request-btn span:not(.audio-icon) {
    display: none !important;
    visibility: hidden !important;
    width: 0 !important;
    height: 0 !important;
    overflow: hidden !important;
    text-indent: -9999px !important;
}

.audio-play-btn:hover,
.audio-play-btn:focus,
.audio-request-btn:hover,
.audio-request-btn:focus {
    opacity: 0.7;
    outline: 2px solid #3498db;
    outline-offset: 2px;
}

.audio-play-btn:disabled,
.audio-request-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.audio-fallback-btn {
    opacity: 0.8;
}

.audio-fallback-btn:hover,
.audio-fallback-btn:focus {
    opacity: 0.6;
}

.audio-icon {
    width: 32px !important;
    height: 32px !important;
    object-fit: contain;
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
}

.audio-player-container {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    background-color: #f5f5f5;
    border-radius: 4px;
}

.audio-player-container audio {
    max-width: 300px;
}

.audio-close-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #666;
    padding: 0;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background-color 0.2s;
}

.audio-close-btn:hover,
.audio-close-btn:focus {
    background-color: #ddd;
    outline: 2px solid #666;
    outline-offset: 2px;
}

.audio-request-message {
    padding: 0.5rem;
    border-radius: 4px;
    font-size: 0.875rem;
    margin-top: 0.5rem;
}

.audio-request-message.success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.audio-request-message.error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.audio-error {
    color: #e74c3c;
    font-size: 0.875rem;
    margin-top: 0.5rem;
}
</style>
