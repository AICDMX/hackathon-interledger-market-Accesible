{% load i18n static %}
{% comment %}
Audio player template component.
Usage: {% audio_player content_object "title" "en" %}
{% endcomment %}

{# Audio configuration and script are loaded once in base.html #}
{# Only set config if not already set (for edge cases) #}
<script>
if (!window.AUDIO_CONFIG) {
    window.AUDIO_CONFIG = {
        iconInactive: '{{ audio_config.icon_inactive }}',
        iconActive: '{{ audio_config.icon_active }}',
        fallbackAudio: {{ audio_config.fallback_audio|safe }},
        fallbackFile: '{{ audio_config.fallback_file }}',
        staticUrl: '{{ audio_config.static_url }}'
    };
}
</script>

<div class="audio-player-wrapper" 
     data-audio-target="{{ target_field }}"
     data-content-type="{{ content_type_id }}"
     data-object-id="{{ object_id }}"
     data-language="{{ language_code }}">
    
    {% if audio_snippet and audio_snippet.file %}
        {# Audio available - show player #}
        <button type="button" class="audio-play-btn" 
                aria-label="{% blocktrans with field=target_field lang=language_code %}Play audio for {{ field }} in {{ lang }}{% endblocktrans %}"
                onclick="playAudio(this, event)">
            <img src="{{ audio_config.icon_inactive }}" alt="{% trans 'Listen' %}" class="audio-icon" aria-hidden="true">
        </button>
        
        <div class="audio-player-container" style="display: none;">
            <audio controls 
                   preload="none"
                   aria-label="{% blocktrans with field=target_field lang=language_code %}Audio player for {{ field }} in {{ lang }}{% endblocktrans %}">
                <source src="{{ audio_snippet.file.url }}" type="audio/mpeg">
                <source src="{{ audio_snippet.file.url }}" type="audio/ogg">
                {% trans "Your browser does not support the audio element." %}
            </audio>
            <button type="button" class="audio-close-btn" onclick="closeAudioPlayer(this, event); return false;" aria-label="{% trans 'Close audio player' %}">?</button>
        </div>
    {% else %}
        {# Audio not available - show request button #}
        <button type="button" class="audio-request-btn" 
                aria-label="{% blocktrans with field=target_field lang=language_code %}Request audio for {{ field }} in {{ lang }}{% endblocktrans %}"
                onclick="requestAudio(this, event)">
            <img src="{{ audio_config.icon_inactive }}" alt="{% trans 'Request audio' %}" class="audio-icon" aria-hidden="true">
        </button>
        
        <div class="audio-request-message" style="display: none;" role="alert"></div>
    {% endif %}
</div>

<script>
// Audio player functionality - uses centralized module
function playAudio(button, event) {
    // Prevent form submission if button is inside a form
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    } else {
        // If event not passed, try to get it from window.event (for inline handlers)
        const evt = window.event || arguments[1];
        if (evt) {
            evt.preventDefault();
            evt.stopPropagation();
        }
    }
    
    // Ensure button doesn't submit form
    if (button.form) {
        button.form.addEventListener('submit', function(e) {
            if (e.submitter === button) {
                e.preventDefault();
            }
        }, { once: true });
    }
    
    const wrapper = button.closest('.audio-player-wrapper');
    const playerContainer = wrapper.querySelector('.audio-player-container');
    const audio = playerContainer ? playerContainer.querySelector('audio') : null;
    const icon = button.querySelector('.audio-icon');
    
    if (!audio) {
        // No audio element found - use fallback
        const languageCode = wrapper.dataset.language || '{{ preferred_audio_language|default:LANGUAGE_CODE }}';
        playFallbackAudio(button, languageCode);
        return false;
    }
    
    // Use centralized module to play with icon management
    window.AudioPlayerModule.playAudioWithIcon(audio, icon).catch(err => {
        console.error('Error playing audio:', err);
        // If audio fails, try fallback
        const languageCode = wrapper.dataset.language || '{{ preferred_audio_language|default:LANGUAGE_CODE }}';
        playFallbackAudio(button, languageCode);
    });
    
    return false;
}

function closeAudioPlayer(button, event) {
    // Prevent form submission if button is inside a form
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    } else {
        // If event not passed, try to get it from window.event (for inline handlers)
        const evt = window.event || arguments[1];
        if (evt) {
            evt.preventDefault();
            evt.stopPropagation();
        }
    }
    
    const container = button.closest('.audio-player-container');
    const wrapper = container.closest('.audio-player-wrapper');
    const playBtn = wrapper.querySelector('.audio-play-btn');
    const audio = container.querySelector('audio');
    const icon = playBtn ? playBtn.querySelector('.audio-icon') : null;
    
    // Stop audio
    audio.pause();
    audio.currentTime = 0;
    
    // Reset icon to inactive
    if (icon) {
        window.AudioPlayerModule.setIconState(icon, 'inactive');
    }
    
    // Hide player, show button
    container.style.display = 'none';
    if (playBtn) {
        playBtn.style.display = 'inline-flex';
    }
    
    return false;
}

function requestAudio(button, event) {
    // Prevent form submission if button is inside a form
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    } else {
        // If event not passed, try to get it from window.event (for inline handlers)
        const evt = window.event || arguments[1];
        if (evt) {
            evt.preventDefault();
            evt.stopPropagation();
        }
    }
    
    // Ensure button doesn't submit form
    if (button.form) {
        button.form.addEventListener('submit', function(e) {
            if (e.submitter === button) {
                e.preventDefault();
            }
        }, { once: true });
    }
    
    const wrapper = button.closest('.audio-player-wrapper');
    const languageCode = wrapper.dataset.language || '{{ preferred_audio_language|default:LANGUAGE_CODE }}';
    
    // Instead of requesting, play fallback audio
    playFallbackAudio(button, languageCode);
    
    return false;
}

function playFallbackAudio(button, languageCode) {
    const icon = button.querySelector('.audio-icon');
    
    // Use centralized module
    window.AudioPlayerModule.playFallbackAudio(languageCode, icon).catch(err => {
        console.error('Error playing fallback audio:', err);
    });
}
</script>

<style>
.audio-player-wrapper {
    display: inline-flex;
    align-items: center;
    vertical-align: middle;
    gap: 0.25rem;
    margin-left: 0.25rem;
    flex-shrink: 0;
}

.audio-play-btn,
.audio-request-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    background-color: transparent;
    border: none;
    cursor: pointer;
    transition: opacity 0.2s;
    min-width: 32px;
    min-height: 32px;
    vertical-align: middle;
    line-height: 1;
}

.audio-play-btn *,
.audio-request-btn * {
    pointer-events: none;
}

.audio-play-btn .audio-label,
.audio-request-btn .audio-label,
.audio-play-btn span:not(.audio-icon),
.audio-request-btn span:not(.audio-icon) {
    display: none !important;
    visibility: hidden !important;
    width: 0 !important;
    height: 0 !important;
    overflow: hidden !important;
    text-indent: -9999px !important;
}

.audio-play-btn:hover,
.audio-play-btn:focus,
.audio-request-btn:hover,
.audio-request-btn:focus {
    opacity: 0.7;
    outline: 2px solid #3498db;
    outline-offset: 2px;
}

.audio-play-btn:disabled,
.audio-request-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.audio-icon {
    width: 32px !important;
    height: 32px !important;
    object-fit: contain;
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
}

.audio-player-container {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    background-color: #f5f5f5;
    border-radius: 4px;
}

.audio-player-container audio {
    max-width: 300px;
}

.audio-close-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #666;
    padding: 0;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background-color 0.2s;
}

.audio-close-btn:hover,
.audio-close-btn:focus {
    background-color: #ddd;
    outline: 2px solid #666;
    outline-offset: 2px;
}

.audio-request-message {
    padding: 0.5rem;
    border-radius: 4px;
    font-size: 0.875rem;
    margin-top: 0.5rem;
}

.audio-request-message.success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.audio-request-message.error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.audio-error {
    color: #e74c3c;
    font-size: 0.875rem;
    margin-top: 0.5rem;
}
</style>
