{% extends 'base.html' %}
{% load i18n audio_tags %}

{% block title %}{{ job.title }} - {{ block.super }}{% endblock %}

{% block content %}
<article class="card">
    {% include 'components/title_with_audio.html' with title=job.title content_object=job field_name="title" heading_tag="h1" %}
    
    <div>
        <p><strong>{% trans 'Funder' %}:</strong> {{ job.funder.get_display_name }}</p>
        <p><strong>{% trans 'Status' %}:</strong> {{ job.get_status_display }}</p>
        <p><strong>{% trans 'Target Language' %}:</strong> {{ job.target_language }}</p>
        {% if job.target_dialect %}
            <p><strong>{% trans 'Dialect' %}:</strong> {{ job.target_dialect }}</p>
        {% endif %}
        <p><strong>{% trans 'Amount Per Person' %}:</strong> {{ job.amount_per_person }} pesos</p>
        <p><strong>{% trans 'Total Budget' %}:</strong> {{ job.budget }} pesos ({{ job.amount_per_person }} ? {{ job.max_responses }})</p>
        
        <p><strong>{% trans 'Responses Needed' %}:</strong> 
            {{ job.get_accepted_submissions_count }} / {{ job.max_responses }} {% trans 'accepted' %}
            {% if not job.has_reached_max_responses %}
                <span class="text-info">({% trans 'Still accepting submissions' %})</span>
            {% else %}
                <span class="text-success">({% trans 'Complete' %})</span>
            {% endif %}
        </p>
        
        <p><strong>{% trans 'Deliverable Types' %}:</strong> {{ job.get_deliverable_types_display }}</p>
        <p><strong>{% trans 'Created' %}:</strong> {{ job.created_at|date:"F d, Y" }}</p>
        
        {% if job.has_reference_media %}
            <div class="card" style="margin-top: 1rem;">
            <div>
                {% include 'components/static_title_with_audio.html' with title_text="Reference Media From Funder" slug="section_reference_media" heading_tag="h3" %}
                <p class="muted-text">{% trans 'Use these examples to better understand the request.' %}</p>
                {% if job.reference_audio %}
                    <div style="margin-bottom: 0.75rem;">
                        <p style="margin-bottom: 0.25rem;"><strong>{% trans 'Audio instructions' %}</strong></p>
                        <audio controls src="{{ job.reference_audio.url }}" style="width: 100%;">
                            {% trans 'Your browser does not support the audio element.' %}
                        </audio>
                    </div>
                {% endif %}
                {% if job.reference_video %}
                    <div style="margin-bottom: 0.75rem;">
                        <p style="margin-bottom: 0.25rem;"><strong>{% trans 'Video reference' %}</strong></p>
                        <video controls src="{{ job.reference_video.url }}" style="width: 100%; max-height: 360px;">
                            {% trans 'Your browser does not support the video element.' %}
                        </video>
                    </div>
                {% endif %}
                {% if job.reference_image %}
                    <div>
                        <p style="margin-bottom: 0.25rem;"><strong>{% trans 'Image reference' %}</strong></p>
                        <img src="{{ job.reference_image.url }}" alt="{% trans 'Reference image for this job' %}" style="max-width: 100%; border-radius: 0.5rem;">
                    </div>
                {% endif %}
            </div>
        {% endif %}
    </div>
    
    <div>
        {% include 'components/static_title_with_audio.html' with title_text="Description" slug="section_description" heading_tag="h2" %}
        <p>{{ job.description|linebreaks }}</p>
    </div>
    
    {% if user.is_authenticated %}
        {% if user == job.funder %}
            <div style="margin-top: 1.5rem; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                {% if job.status == 'draft' %}
                    <div style="display: inline-flex; align-items: center; gap: 0.5rem;">
                        <a href="{% url 'jobs:edit' job.pk %}" class="btn btn-primary">{% trans 'Edit Draft' %}</a>
                        {% audio_player_static_ui "button_edit_draft" "label" %}
                    </div>
                {% endif %}
                <form method="post" action="{% url 'jobs:duplicate' job.pk %}" style="display: inline;">
                    {% csrf_token %}
                    <div style="display: inline-flex; align-items: center; gap: 0.5rem;">
                        <button type="submit" class="btn btn-secondary">{% trans 'Duplicate Job' %}</button>
                        {% audio_player_static_ui "button_duplicate_job" "label" %}
                    </div>
                </form>
            </div>
            
            <div class="card" style="margin-top: 1rem; background-color: #fff7ed; border: 2px solid #fb923c;">
                {% include 'components/static_title_with_audio.html' with title_text="Approve Quote & Pay" slug="section_approve_quote" heading_tag="h2" %}
                <p class="muted-text">{% trans 'Start the payment flow. You will be redirected to your wallet.' %}</p>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <a href="{% url 'jobs:approve_quote' job.pk %}" class="btn btn-primary">{% trans 'Approve quote & pay' %}</a>
                    {% audio_player_static_ui "button_approve_quote" "label" %}
                </div>
            </div>
            
            <div>
                {% include 'components/static_title_with_audio.html' with title_text="Submissions" slug="section_submissions" heading_tag="h2" %}
                {% if job.submissions.all %}
                    <ul>
                        {% for submission in job.submissions.all %}
                            <li>
                                <strong>{{ submission.creator.username }}</strong> - 
                                {{ submission.get_status_display }}
                                {% if submission.status == 'pending' %}
                                    <div style="display: inline-flex; align-items: center; gap: 0.5rem;">
                                        <a href="{% url 'jobs:accept_submission' job.pk submission.pk %}" class="btn btn-success">{% trans 'Accept' %}</a>
                                        {% audio_player_static_ui "button_accept" "label" %}
                                        <a href="{% url 'jobs:decline_submission' job.pk submission.pk %}" class="btn btn-danger">{% trans 'Decline' %}</a>
                                        {% audio_player_static_ui "button_decline" "label" %}
                                    </div>
                                {% endif %}
                                {% if submission.note %}
                                    <p>{{ submission.note }}</p>
                                {% endif %}
                                {% if submission.text_content %}
                                    <div style="margin-top:0.5rem;">
                                        <p><strong>{% trans 'Text Content' %}:</strong></p>
                                        <div style="background-color: #f5f5f5; padding: 1rem; border-radius: 0.5rem; white-space: pre-wrap;">{{ submission.text_content }}</div>
                                    </div>
                                {% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>{% trans 'No submissions yet.' %}</p>
                {% endif %}
            </div>
            
            {% if job.status == 'recruiting' or job.status == 'selecting' %}
                <div style="margin-top: 1.5rem;">
                    {% include 'components/static_title_with_audio.html' with title_text="Applications" slug="section_applications" heading_tag="h2" %}
                    {% if applications %}
                        <p><strong>{% trans 'Approved Applicants' %}:</strong> {{ selected_count }} / {{ job.max_responses }}</p>
                        <p><strong>{% trans 'Total Applications' %}:</strong> {{ applications.count }}</p>
                        <div style="margin-top: 1rem;">
                            {% for application in applications %}
                                <div class="card" style="margin-top: 0.75rem; border-left: 4px solid {% if application.status == 'selected' %}#10b981{% elif application.status == 'rejected' %}#ef4444{% else %}#f59e0b{% endif %};">
                                    <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 1rem;">
                                        <div style="flex: 1;">
                                            <h3 style="margin: 0;">{{ application.applicant.get_display_name }}</h3>
                                            <p class="text-muted" style="margin: 0.25rem 0;">
                                                {% trans 'Applied' %}: {{ application.created_at|date:"F d, Y H:i" }}
                                            </p>
                                            <p style="margin: 0.25rem 0;">
                                                <strong>{% trans 'Status' %}:</strong> 
                                                <span class="status-pill status-{{ application.status }}">
                                                    {{ application.get_status_display }}
                                                </span>
                                            </p>
                                        </div>
                                        <div>
                                            {% if application.status == 'pending' %}
                                                <form method="post" action="{% url 'jobs:select_application' job.pk application.pk %}" style="display: inline;">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="action" value="approve">
                                                    <div style="display: inline-flex; align-items: center; gap: 0.5rem;">
                                                        <button type="submit" class="btn btn-success">{% trans 'Approve' %}</button>
                                                        {% audio_player_static_ui "button_approve" "label" %}
                                                    </div>
                                                </form>
                                                <form method="post" action="{% url 'jobs:select_application' job.pk application.pk %}" style="display: inline;">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="action" value="reject">
                                                    <div style="display: inline-flex; align-items: center; gap: 0.5rem;">
                                                        <button type="submit" class="btn btn-danger">{% trans 'Reject' %}</button>
                                                        {% audio_player_static_ui "button_reject" "label" %}
                                                    </div>
                                                </form>
                                            {% elif application.status == 'selected' %}
                                                <form method="post" action="{% url 'jobs:select_application' job.pk application.pk %}" style="display: inline;">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="action" value="pending">
                                                    <div style="display: inline-flex; align-items: center; gap: 0.5rem;">
                                                        <button type="submit" class="btn">{% trans 'Reset to Pending' %}</button>
                                                        {% audio_player_static_ui "button_reset_to_pending" "label" %}
                                                    </div>
                                                </form>
                                            {% elif application.status == 'rejected' %}
                                                <form method="post" action="{% url 'jobs:select_application' job.pk application.pk %}" style="display: inline;">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="action" value="pending">
                                                    <div style="display: inline-flex; align-items: center; gap: 0.5rem;">
                                                        <button type="submit" class="btn">{% trans 'Reset to Pending' %}</button>
                                                        {% audio_player_static_ui "button_reset_to_pending" "label" %}
                                                    </div>
                                                </form>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    {% if application.profile_note %}
                                        <div style="margin-top: 1rem;">
                                            <strong>{% trans 'Profile Note' %}:</strong>
                                            <p>{{ application.profile_note|linebreaks }}</p>
                                        </div>
                                    {% endif %}
                                    
                                    {% if application.profile_audio or application.profile_video or application.profile_image %}
                                        <div style="margin-top: 1rem;">
                                            <strong>{% trans 'Profile Media' %}:</strong>
                                            <div style="display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 0.5rem;">
                                                {% if application.profile_audio %}
                                                    <div>
                                                        <p style="margin-bottom: 0.25rem;"><strong>{% trans 'Audio' %}</strong></p>
                                                        <audio controls src="{{ application.profile_audio.url }}" style="width: 100%; max-width: 300px;">
                                                            {% trans 'Your browser does not support the audio element.' %}
                                                        </audio>
                                                    </div>
                                                {% endif %}
                                                {% if application.profile_video %}
                                                    <div>
                                                        <p style="margin-bottom: 0.25rem;"><strong>{% trans 'Video' %}</strong></p>
                                                        <video controls src="{{ application.profile_video.url }}" style="width: 100%; max-width: 300px; max-height: 200px;">
                                                            {% trans 'Your browser does not support the video element.' %}
                                                        </video>
                                                    </div>
                                                {% endif %}
                                                {% if application.profile_image %}
                                                    <div>
                                                        <p style="margin-bottom: 0.25rem;"><strong>{% trans 'Image' %}</strong></p>
                                                        <img src="{{ application.profile_image.url }}" alt="{% trans 'Profile image' %}" style="max-width: 200px; border-radius: 0.5rem;">
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p>{% trans 'No applications yet.' %}</p>
                    {% endif %}
                </div>
                
                {% if show_start_contract_button %}
                    <div class="card" style="margin-top: 1.5rem; background-color: {% if can_start_contract %}#f0fdf4{% else %}#f9fafb{% endif %}; border: 2px solid {% if can_start_contract %}#10b981{% else %}#d1d5db{% endif %};">
                        {% include 'components/static_title_with_audio.html' with title_text="Start Contract" slug="section_start_contract" heading_tag="h2" %}
                        <p>{% trans 'Approved' %}: {{ selected_count }} / {{ job.max_responses }} {% trans 'applicants' %}</p>
                        {% if selected_count < job.max_responses %}
                            <p class="text-warning">{% blocktrans with selected=selected_count max=job.max_responses %}You have approved {{ selected }} out of {{ max }} requested workers. You can start the contract now with the currently approved workers, but no more applications will be accepted after starting.{% endblocktrans %}</p>
                        {% endif %}
                        <form method="post" action="{% url 'jobs:pre_approve_payments' job.pk %}" id="start-contract-form">
                            {% csrf_token %}
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <button type="submit" 
                                        class="btn {% if can_start_contract %}btn-primary{% else %}btn-secondary{% endif %}" 
                                        id="start-contract-btn"
                                        {% if not can_start_contract %}disabled{% endif %}>
                                    {% trans 'Start Contract' %}
                                </button>
                                {% audio_player_static_ui "button_start_contract" "label" %}
                            </div>
                        </form>
                        {% if not can_start_contract %}
                            <p class="text-muted" style="margin-top: 0.5rem; font-size: 0.875rem;">
                                {% trans 'Approve at least one applicant to start the contract.' %}
                            </p>
                        {% endif %}
                    </div>
                {% endif %}
            {% endif %}
            
            {% if show_cancel_contract_button %}
                <div class="card" style="margin-top: 1.5rem; background-color: #fef2f2; border: 2px solid #ef4444;">
                    {% include 'components/static_title_with_audio.html' with title_text="Cancel Contract" slug="section_cancel_contract" heading_tag="h2" %}
                    <p>{% trans 'Cancel this contract/job. This action cannot be undone. No further actions can be taken on this job after cancellation.' %}</p>
                    <form method="post" action="{% url 'jobs:cancel_contract' job.pk %}" id="cancel-contract-form">
                        {% csrf_token %}
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <button type="submit" 
                                    class="btn btn-danger" 
                                    id="cancel-contract-btn"
                                    onclick="return confirm('{% trans 'Are you sure you want to cancel this contract? This action cannot be undone.' %}');">
                                {% trans 'Cancel Contract' %}
                            </button>
                            {% audio_player_static_ui "button_cancel_contract" "label" %}
                        </div>
                    </form>
                </div>
            {% endif %}
            
            {% if job.status == 'canceled' %}
                <div class="card" style="margin-top: 1.5rem; background-color: #fef2f2; border: 2px solid #ef4444;">
                    <p><strong>{% trans 'This job has been canceled.' %}</strong> {% trans 'No further actions can be taken on this job.' %}</p>
                </div>
            {% endif %}
            
            {% if show_complete_contract_button %}
                <div class="card" style="margin-top: 1.5rem; background-color: {% if can_complete_contract %}#f0fdf4{% else %}#f9fafb{% endif %}; border: 2px solid {% if can_complete_contract %}#10b981{% else %}#d1d5db{% endif %};">
                    {% include 'components/static_title_with_audio.html' with title_text="Complete Contract" slug="section_complete_contract" heading_tag="h2" %}
                    <p>{% trans 'Accepted Submissions' %}: {{ accepted_submissions_count }} / {{ job.max_responses }}</p>
                    {% if accepted_submissions_count < job.max_responses %}
                        <p class="text-warning">{% blocktrans with accepted=accepted_submissions_count max=job.max_responses %}You have {{ accepted }} accepted submission(s) out of {{ max }} requested. You can complete the contract now with the currently accepted submissions, but no more submissions will be accepted after completing.{% endblocktrans %}</p>
                    {% endif %}
                    {% if accepted_submissions_count > 0 %}
                        <p>{% trans 'All accepted submissions are ready. You can now complete the contract to release payments.' %}</p>
                    {% endif %}
                    <form method="post" action="{% url 'jobs:complete_contract' job.pk %}" id="complete-contract-form">
                        {% csrf_token %}
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <button type="submit" 
                                    class="btn btn-success" 
                                    id="complete-contract-btn">
                                {% trans 'Complete Contract' %}
                            </button>
                            {% audio_player_static_ui "button_complete_contract" "label" %}
                        </div>
                    </form>
                    <p class="text-muted" style="margin-top: 0.5rem; font-size: 0.875rem;">
                        {% trans 'Note: Payment release functionality is coming soon.' %}
                    </p>
                </div>
            {% endif %}
        {% else %}
            {% if job.status == 'submitting' %}
                {% if job.has_reached_max_responses %}
                    <div class="card bg-info">
                        <p>{% blocktrans with max=job.max_responses %}This job has reached its maximum number of responses ({{ max }}). No more submissions are being accepted.{% endblocktrans %}</p>
                    </div>
                {% elif user_submissions %}
                    <div class="card bg-info">
                        <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                            <p style="margin: 0;">{% trans 'You have already submitted work for this job. You can only submit once per job.' %}</p>
                            {% audio_player_static_ui "message_already_submitted" "label" %}
                        </div>
                    </div>
                {% else %}
                    <div class="card bg-success" style="margin-top: 1.5rem; padding: 1.5rem; text-align: center;">
                        {% include 'components/static_title_with_audio.html' with title_text="Ready to Submit Work?" slug="section_ready_to_submit" heading_tag="h2" %}
                        <p style="margin-bottom: 1rem;">{% trans 'This job is accepting submissions. Click below to submit your work.' %}</p>
                        <div style="display: flex; align-items: center; gap: 0.5rem; justify-content: center;">
                            <a href="{% url 'jobs:submit' job.pk %}" class="btn btn-primary" style="font-size: 1.25rem; padding: 0.75rem 2rem;">
                                {% trans 'Submit Work for This Job' %}
                            </a>
                            {% audio_player_static_ui "button_submit_work_for_job" "label" %}
                        </div>
                    </div>
                {% endif %}
            {% elif job.status == 'draft' or job.status == 'recruiting' or job.status == 'selecting' %}
                {% if job.status == 'recruiting' and not user_application %}
                    <div class="card bg-success" style="margin-top: 1.5rem; padding: 1.5rem; text-align: center;">
                        {% load audio_tags %}
                        {% include 'components/static_title_with_audio.html' with title_text="Interested in This Job?" slug="section_interested_in_job" heading_tag="h2" %}
                        <style>
                            #section_interested_in_job {
                                margin-top: 0;
                            }
                        </style>
                        <p style="margin-bottom: 1rem;">{% trans 'Submit your profile to apply for this job. The job owner will review applications and select workers.' %}</p>
                        <div style="display: flex; align-items: center; gap: 0.5rem; justify-content: center;">
                            <a href="{% url 'jobs:apply_to_job' job.pk %}" class="btn btn-primary" style="font-size: 1.25rem; padding: 0.75rem 2rem;">
                                {% trans 'Apply to This Job' %}
                            </a>
                            {% audio_player_static_ui "button_apply_to_job" "label" %}
                        </div>
                    </div>
                {% endif %}
            {% elif job.status == 'reviewing' %}
                <div class="card bg-info">
                    <p>{% trans 'This job is waiting for the funder to review submissions. No additional submissions are being accepted right now.' %}</p>
                </div>
            {% elif job.status == 'complete' %}
                <div class="card bg-info">
                    <p>{% trans 'This job has been completed and is no longer accepting submissions.' %}</p>
                </div>
            {% endif %}
            
            {% if user_submissions %}
                <div>
                    {% include 'components/static_title_with_audio.html' with title_text="Your Submissions" slug="section_your_submissions" heading_tag="h2" %}
                    <ul>
                        {% for submission in user_submissions %}
                            <li>
                                <strong>{{ submission.get_status_display }}</strong> - {{ submission.created_at|date:"F d, Y" }}
                                {% if submission.status == 'accepted' %}
                                    <span class="text-success" style="margin-left: 0.5rem;">? {% trans 'Accepted' %}</span>
                                {% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}
        {% endif %}
    {% else %}
        <p><a href="{% url 'users:login' %}">{% trans 'Login' %}</a> {% trans 'to submit work for this job.' %}</p>
    {% endif %}
</article>

{% if user.is_authenticated and user == job.funder and show_start_contract_button %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const startContractForm = document.getElementById('start-contract-form');
    const startContractBtn = document.getElementById('start-contract-btn');
    
    if (startContractForm && startContractBtn) {
        const submitHandler = function(e) {
            e.preventDefault();
            
            const selectedCount = {{ selected_count }};
            const maxResponses = {{ job.max_responses }};
            
            let message;
            if (selectedCount < maxResponses) {
                message = {% blocktrans with selected=selected_count max=job.max_responses %}'Warning: You are starting the contract with {{ selected }} approved worker(s) out of {{ max }} requested.\n\nOnce the contract is started, no more applications will be accepted and you cannot get additional workers later.\n\nDo you want to continue?'{% endblocktrans %};
            } else {
                message = {% trans 'Are you sure you want to start the contract? This will allow approved workers to submit their work. No more applications will be accepted after starting.' %};
            }
            
            if (confirm(message)) {
                // Remove event listener and submit the form
                startContractForm.removeEventListener('submit', submitHandler);
                startContractForm.submit();
            }
        };
        startContractForm.addEventListener('submit', submitHandler);
    }
});
</script>
{% endif %}

{% if user.is_authenticated and user == job.funder and show_complete_contract_button %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const completeContractForm = document.getElementById('complete-contract-form');
    const completeContractBtn = document.getElementById('complete-contract-btn');
    
    if (completeContractForm && completeContractBtn) {
        const submitHandler = function(e) {
            e.preventDefault();
            
            const acceptedCount = {{ accepted_submissions_count }};
            const maxResponses = {{ job.max_responses }};
            
            let message;
            if (acceptedCount < maxResponses) {
                message = {% blocktrans with accepted=accepted_submissions_count max=job.max_responses %}'Warning: You are completing the contract with {{ accepted }} accepted submission(s) out of {{ max }} requested.\n\nOnce the contract is completed, no more submissions will be accepted and you cannot get additional workers later.\n\nDo you want to continue?'{% endblocktrans %};
            } else {
                message = {% trans 'Are you sure you want to complete the contract? This will release payments to workers.' %};
            }
            
            if (confirm(message)) {
                // Remove event listener and submit the form
                completeContractForm.removeEventListener('submit', submitHandler);
                completeContractForm.submit();
            }
        };
        completeContractForm.addEventListener('submit', submitHandler);
    }
});
</script>
{% endif %}

<style>
.status-pill {
    padding: 0.25rem 0.75rem;
    border-radius: 999px;
    font-size: 0.875rem;
    font-weight: 600;
    text-transform: capitalize;
    display: inline-block;
}
.status-pending { background-color: #fef3c7; color: #92400e; }
.status-selected { background-color: #dcfce7; color: #166534; }
.status-rejected { background-color: #fee2e2; color: #991b1b; }
</style>
{% endblock %}
