{% extends 'base.html' %}
{% load i18n audio_tags %}

{% block title %}{{ job.title }} - {{ block.super }}{% endblock %}

{% block content %}
<article class="card">
    {% include 'components/title_with_audio.html' with title=job.title content_object=job field_name="title" heading_tag="h1" %}
    
    <div>
        <p><strong>{% trans 'Funder' %}:</strong> {{ job.funder.get_display_name }}</p>
        <p><strong>{% trans 'Status' %}:</strong> {{ job.get_status_display }}</p>
        <p><strong>{% trans 'Target Language' %}:</strong> {{ job.target_language }}</p>
        {% if job.target_dialect %}
            <p><strong>{% trans 'Dialect' %}:</strong> {{ job.target_dialect }}</p>
        {% endif %}
        <p><strong>{% trans 'Amount Per Person' %}:</strong> {{ job.amount_per_person }} pesos</p>
        <p><strong>{% trans 'Total Budget' %}:</strong> {{ job.budget }} pesos ({{ job.amount_per_person }} ? {{ job.max_responses }})</p>
        
        <p><strong>{% trans 'Responses Needed' %}:</strong> 
            {{ job.get_accepted_submissions_count }} / {{ job.max_responses }} {% trans 'accepted' %}
            {% if not job.has_reached_max_responses %}
                <span class="text-info">({% trans 'Still accepting submissions' %})</span>
            {% else %}
                <span class="text-success">({% trans 'Complete' %})</span>
            {% endif %}
        </p>
        
        <p><strong>{% trans 'Deliverable Types' %}:</strong> {{ job.get_deliverable_types_display }}</p>
        <p><strong>{% trans 'Created' %}:</strong> {{ job.created_at|date:"F d, Y" }}</p>
        
        {% if job.has_reference_media %}
            <div class="card" style="margin-top: 1rem;">
            <div>
                {% include 'components/static_title_with_audio.html' with title_text="Reference Media From Funder" slug="section_reference_media" heading_tag="h3" %}
                <p class="muted-text">{% trans 'Use these examples to better understand the request.' %}</p>
                {% if job.reference_audio %}
                    <div style="margin-bottom: 0.75rem;">
                        <p style="margin-bottom: 0.25rem;"><strong>{% trans 'Audio instructions' %}</strong></p>
                        <audio controls src="{{ job.reference_audio.url }}" style="width: 100%;">
                            {% trans 'Your browser does not support the audio element.' %}
                        </audio>
                    </div>
                {% endif %}
                {% if job.reference_video %}
                    <div style="margin-bottom: 0.75rem;">
                        <p style="margin-bottom: 0.25rem;"><strong>{% trans 'Video reference' %}</strong></p>
                        <video controls src="{{ job.reference_video.url }}" style="width: 100%; max-height: 360px;">
                            {% trans 'Your browser does not support the video element.' %}
                        </video>
                    </div>
                {% endif %}
                {% if job.reference_image %}
                    <div>
                        <p style="margin-bottom: 0.25rem;"><strong>{% trans 'Image reference' %}</strong></p>
                        <img src="{{ job.reference_image.url }}" alt="{% trans 'Reference image for this job' %}" style="max-width: 100%; border-radius: 0.5rem;">
                    </div>
                {% endif %}
            </div>
        {% endif %}
    </div>
    
    <div>
        {% include 'components/static_title_with_audio.html' with title_text="Description" slug="section_description" heading_tag="h2" %}
        <p>{{ job.description|linebreaks }}</p>
    </div>
    
    {% if user.is_authenticated %}
        {% if user == job.funder %}
            <div class="card" style="margin-top: 1rem; background-color: #fff7ed; border: 2px solid #fb923c;">
                {% include 'components/static_title_with_audio.html' with title_text="Approve Quote & Pay" slug="section_approve_quote" heading_tag="h2" %}
                {% if job.payment_url %}
                    <p class="muted-text">{% trans 'Payment link has been generated. Click below to complete payment.' %}</p>
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <a href="{{ job.payment_url }}" class="btn btn-primary" target="_blank" rel="noopener noreferrer">
                                {% trans 'Complete Payment' %}
                            </a>
                            {% audio_player_static_ui "button_complete_payment" "label" %}
                        </div>
                        <div style="background-color: #f5f5f5; padding: 0.75rem; border-radius: 0.5rem; word-break: break-all;">
                            <p style="margin: 0; font-size: 0.875rem;"><strong>{% trans 'Payment Link:' %}</strong></p>
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem; font-family: monospace;">{{ job.payment_url }}</p>
                        </div>
                        {% if job.payment_id %}
                            <p style="margin: 0; font-size: 0.75rem; color: #666;">
                                {% trans 'Payment ID:' %} <code>{{ job.payment_id }}</code>
                            </p>
                        {% endif %}
                    </div>
                {% else %}
                    <p class="muted-text">{% trans 'Start the payment flow. You will be redirected to your wallet.' %}</p>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <a href="{% url 'jobs:approve_quote' job.pk %}" class="btn btn-primary">{% trans 'Approve quote & pay' %}</a>
                        {% audio_player_static_ui "button_approve_quote" "label" %}
                    </div>
                {% endif %}
            </div>
            <div>
                {% include 'components/static_title_with_audio.html' with title_text="Submissions" slug="section_submissions" heading_tag="h2" %}
                {% if job.submissions.all %}
                    <ul>
                        {% for submission in job.submissions.all %}
                            <li>
                                <strong>{{ submission.creator.username }}</strong> - 
                                {{ submission.get_status_display }}
                                {% if submission.status == 'pending' %}
                                    <div style="display: inline-flex; align-items: center; gap: 0.5rem;">
                                        <a href="{% url 'jobs:accept_submission' job.pk submission.pk %}" class="btn btn-success">{% trans 'Accept' %}</a>
                                        {% audio_player_static_ui "button_accept" "label" %}
                                    </div>
                                {% endif %}
                                {% if submission.note %}
                                    <p>{{ submission.note }}</p>
                                {% endif %}
                                {% if submission.text_content %}
                                    <div style="margin-top:0.5rem;">
                                        <p><strong>{% trans 'Text Content' %}:</strong></p>
                                        <div style="background-color: #f5f5f5; padding: 1rem; border-radius: 0.5rem; white-space: pre-wrap;">{{ submission.text_content }}</div>
                                    </div>
                                {% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>{% trans 'No submissions yet.' %}</p>
                {% endif %}
            </div>
            
            {% if can_complete_contract %}
                <div class="card" style="margin-top: 1.5rem; background-color: #f0fdf4; border: 2px solid #10b981;">
                    {% include 'components/static_title_with_audio.html' with title_text="Complete Contract" slug="section_complete_contract" heading_tag="h2" %}
                    <p>{% trans 'All accepted submissions have been marked as complete by workers. You can now complete the contract to release payments.' %}</p>
                    <form method="post" action="{% url 'jobs:complete_contract' job.pk %}">
                        {% csrf_token %}
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <button type="submit" class="btn btn-success">{% trans 'Complete Contract' %}</button>
                            {% audio_player_static_ui "button_complete_contract" "label" %}
                        </div>
                    </form>
                    <p class="text-muted" style="margin-top: 0.5rem; font-size: 0.875rem;">
                        {% trans 'Note: Payment release functionality is coming soon.' %}
                    </p>
                </div>
            {% elif job.contract_completed and job.status != 'complete' %}
                <div class="card" style="margin-top: 1.5rem; background-color: #eff6ff; border: 2px solid #3b82f6;">
                    <p>{% trans 'Contract has been completed. You can now mark the job as complete.' %}</p>
                    <form method="post" action="{% url 'jobs:mark_job_completed' job.pk %}">
                        {% csrf_token %}
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <button type="submit" class="btn btn-primary">{% trans 'Mark job completed' %}</button>
                            {% audio_player_static_ui "button_mark_job_completed" "label" %}
                        </div>
                    </form>
                </div>
            {% endif %}
        {% else %}
            {% if job.status == 'submitting' %}
                {% if job.has_reached_max_responses %}
                    <div class="card bg-info">
                        <p>{% blocktrans with max=job.max_responses %}This job has reached its maximum number of responses ({{ max }}). No more submissions are being accepted.{% endblocktrans %}</p>
                    </div>
                {% elif user_submissions %}
                    <div class="card bg-info">
                        <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                            <p style="margin: 0;">{% trans 'You have already submitted work for this job. You can only submit once per job.' %}</p>
                            {% audio_player_static_ui "message_already_submitted" "label" %}
                        </div>
                    </div>
                {% else %}
                    <div class="card bg-success" style="margin-top: 1.5rem; padding: 1.5rem; text-align: center;">
                        {% include 'components/static_title_with_audio.html' with title_text="Ready to Submit Work?" slug="section_ready_to_submit" heading_tag="h2" %}
                        <p style="margin-bottom: 1rem;">{% trans 'This job is accepting submissions. Click below to submit your work.' %}</p>
                        <div style="display: flex; align-items: center; gap: 0.5rem; justify-content: center;">
                            <a href="{% url 'jobs:submit' job.pk %}" class="btn btn-primary" style="font-size: 1.25rem; padding: 0.75rem 2rem;">
                                {% trans 'Submit Work for This Job' %}
                            </a>
                            {% audio_player_static_ui "button_submit_work_for_job" "label" %}
                        </div>
                    </div>
                {% endif %}
            {% elif job.status == 'draft' or job.status == 'recruiting' or job.status == 'selecting' %}
                {% if job.status == 'recruiting' and not user_application %}
                    <div class="card bg-success" style="margin-top: 1.5rem; padding: 1.5rem; text-align: center;">
                        {% load audio_tags %}
                        {% include 'components/static_title_with_audio.html' with title_text="Interested in This Job?" slug="section_interested_in_job" heading_tag="h2" %}
                        <style>
                            #section_interested_in_job {
                                margin-top: 0;
                            }
                        </style>
                        <p style="margin-bottom: 1rem;">{% trans 'Submit your profile to apply for this job. The job owner will review applications and select workers.' %}</p>
                        <div style="display: flex; align-items: center; gap: 0.5rem; justify-content: center;">
                            <a href="{% url 'jobs:apply_to_job' job.pk %}" class="btn btn-primary" style="font-size: 1.25rem; padding: 0.75rem 2rem;">
                                {% trans 'Apply to This Job' %}
                            </a>
                            {% audio_player_static_ui "button_apply_to_job" "label" %}
                        </div>
                    </div>
                {% endif %}
            {% elif job.status == 'reviewing' %}
                <div class="card bg-info">
                    <p>{% trans 'This job is waiting for the funder to review submissions. No additional submissions are being accepted right now.' %}</p>
                </div>
            {% elif job.status == 'complete' %}
                <div class="card bg-info">
                    <p>{% trans 'This job has been completed and is no longer accepting submissions.' %}</p>
                </div>
            {% endif %}
            
            {% if user_submissions %}
                <div>
                    {% include 'components/static_title_with_audio.html' with title_text="Your Submissions" slug="section_your_submissions" heading_tag="h2" %}
                    <ul>
                        {% for submission in user_submissions %}
                            <li>
                                {{ submission.get_status_display }} - {{ submission.created_at|date:"F d, Y" }}
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}
        {% endif %}
    {% else %}
        <p><a href="{% url 'users:login' %}">{% trans 'Login' %}</a> {% trans 'to submit work for this job.' %}</p>
    {% endif %}
</article>
{% endblock %}
