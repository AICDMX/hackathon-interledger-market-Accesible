{% extends 'base.html' %}
{% load i18n static audio_tags %}

{% block title %}{% trans 'Edit Job' %} - {{ block.super }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'audio/audio-contribution.css' %}">
<style>
    .checkbox-group {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-top: 0.5rem;
    }
    
    .checkbox-group label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0;
        font-weight: normal;
        cursor: pointer;
    }
    
    .checkbox-group input[type="checkbox"] {
        width: auto;
        margin: 0;
        cursor: pointer;
    }
    
    .total-budget-display {
        padding: 0.75rem;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        font-size: 1.25rem;
        color: #495057;
    }
    
    .reference-media-grid {
        display: grid;
        gap: 1.5rem;
        margin-top: 0.5rem;
    }

    .audio-recording-section {
        margin-bottom: 0.5rem;
    }
    
    .draft-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        background-color: #fef3c7;
        color: #92400e;
        border-radius: 999px;
        font-size: 0.875rem;
        font-weight: 600;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
{% load audio_tags %}
{% include 'components/static_title_with_audio.html' with title_text="Edit Job" slug="page_edit_job" heading_tag="h1" %}

{% if job.status == 'draft' %}
    <div class="draft-badge">{% trans 'Draft' %}</div>
{% endif %}

<div class="card">
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        
        <div class="form-group">
            {% include 'components/form_label_with_audio.html' with label_text="Title" slug="form_title" field_id="title" required=True %}
            <input type="text" id="title" name="title" value="{{ title|default:job.title }}" required aria-required="true">
        </div>
        
        <div class="form-group">
            {% include 'components/form_label_with_audio.html' with label_text="Title Audio (Optional)" slug="form_title_audio" field_id="title_audio" %}
            {% if job.title_audio %}
                <p class="text-muted">{% trans 'Current audio:' %} <a href="{{ job.title_audio.url }}" target="_blank">{% trans 'Listen' %}</a></p>
                <p class="text-muted">{% trans 'Upload a new file to replace the existing one.' %}</p>
            {% endif %}
            <p class="muted-text" style="font-size: 0.875rem;">{% trans 'Upload an audio file for the title in the target language' %}</p>
            <input type="file" id="title_audio" name="title_audio" accept="audio/*">
            <small class="form-text text-muted">{% trans 'Optional: Audio pronunciation of the title in the target language' %}</small>
        </div>
        
        <div class="form-group">
            {% include 'components/form_label_with_audio.html' with label_text="Description" slug="form_description" field_id="description" required=True %}
            <textarea id="description" name="description" rows="5" required aria-required="true">{{ description|default:job.description }}</textarea>
        </div>
        
        <div class="form-group">
            {% include 'components/form_label_with_audio.html' with label_text="Target Language" slug="form_target_language" field_id="target_language" required=True %}
            <select id="target_language" name="target_language" required aria-required="true">
                <option value="en" {% if target_language == 'en' or job.target_language == 'en' %}selected{% endif %}>English</option>
                <option value="es" {% if target_language == 'es' or job.target_language == 'es' %}selected{% endif %}>Spanish</option>
                <option value="nah" {% if target_language == 'nah' or job.target_language == 'nah' %}selected{% endif %}>Nahuatl</option>
                <option value="oto" {% if target_language == 'oto' or job.target_language == 'oto' %}selected{% endif %}>Otomi</option>
                <option value="maz" {% if target_language == 'maz' or job.target_language == 'maz' %}selected{% endif %}>Mazahua</option>
                <option value="que" {% if target_language == 'que' or job.target_language == 'que' %}selected{% endif %}>Quechua</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="target_dialect">{% trans 'Target Dialect' %}</label>
            <input type="text" id="target_dialect" name="target_dialect" value="{{ target_dialect|default:job.target_dialect }}">
        </div>
        
        <div class="form-group">
            <label>{% trans 'Deliverable Types' %} *</label>
            <div class="checkbox-group">
                <label>
                    <input type="checkbox" name="deliverable_types" value="text" {% if 'text' in deliverable_types_list %}checked{% endif %}>
                    {% trans 'Text' %}
                </label>
                <label>
                    <input type="checkbox" name="deliverable_types" value="video" {% if 'video' in deliverable_types_list %}checked{% endif %}>
                    {% trans 'Video' %}
                </label>
                <label>
                    <input type="checkbox" name="deliverable_types" value="audio" {% if 'audio' in deliverable_types_list %}checked{% endif %}>
                    {% trans 'Audio' %}
                </label>
                <label>
                    <input type="checkbox" name="deliverable_types" value="image" {% if 'image' in deliverable_types_list %}checked{% endif %}>
                    {% trans 'Image' %}
                </label>
            </div>
            <small class="form-text text-muted">{% trans 'Select one or more deliverable types for this job' %}</small>
        </div>
        
        <div class="form-group">
            {% include 'components/form_label_with_audio.html' with label_text="Amount Per Person (pesos)" slug="form_amount_per_person" field_id="amount_per_person" required=True %}
            <input type="number" id="amount_per_person" name="amount_per_person" step="0.01" min="0" value="{{ amount_per_person|default:job.amount_per_person }}" required aria-required="true">
            <small class="form-text text-muted">{% trans 'How much you will pay each person who completes this job' %}</small>
        </div>
        
        <div class="form-group">
            {% include 'components/form_label_with_audio.html' with label_text="Number of Responses Needed" slug="form_max_responses" field_id="max_responses" required=True %}
            <input type="number" id="max_responses" name="max_responses" min="1" value="{{ max_responses|default:job.max_responses }}" required aria-required="true">
            <small class="form-text text-muted">{% trans 'How many people should submit work for this job? (e.g., if you want 20 people to do the same voice or picture set, enter 20)' %}</small>
        </div>
        
        <div class="form-group">
            <label>{% trans 'Total Budget' %}</label>
            <div id="total-budget-display" class="total-budget-display">
                <strong>{{ job.budget|default:"0.00" }} pesos</strong>
            </div>
            <small class="form-text text-muted">{% trans 'Total amount needed: Amount per person ? Number of responses' %}</small>
        </div>
        
        <div class="form-group">
            <label for="recruit_limit">{% trans 'Recruit Limit' %} *</label>
            <input type="number" id="recruit_limit" name="recruit_limit" min="1" value="{{ recruit_limit|default:job.recruit_limit }}" required aria-required="true">
            <small class="form-text text-muted">{% trans 'Maximum number of applications to accept before automatically moving to selection phase' %}</small>
        </div>
        
        <div class="form-group">
            {% include 'components/form_label_with_audio.html' with label_text="Recruit Deadline (Days)" slug="form_recruit_deadline_days" field_id="recruit_deadline_days" required=True %}
            <input type="number" id="recruit_deadline_days" name="recruit_deadline_days" min="1" value="{{ recruit_deadline_days|default:7 }}" required aria-required="true">
            <small class="form-text text-muted">{% trans 'Number of days from now when recruiting will automatically end and move to selection phase' %}</small>
        </div>
        
        <div class="form-group">
            {% include 'components/form_label_with_audio.html' with label_text="Submit Limit" slug="form_submit_limit" field_id="submit_limit" required=True %}
            <input type="number" id="submit_limit" name="submit_limit" min="1" value="{{ submit_limit|default:job.submit_limit }}" required aria-required="true">
            <small class="form-text text-muted">{% trans 'Maximum number of submissions to accept before automatically moving to review phase' %}</small>
        </div>
        
        <div class="form-group">
            {% include 'components/form_label_with_audio.html' with label_text="Submit Deadline (Days)" slug="form_submit_deadline_days" field_id="submit_deadline_days" required=True %}
            <input type="number" id="submit_deadline_days" name="submit_deadline_days" min="1" value="{{ submit_deadline_days|default:job.submit_deadline_days }}" required aria-required="true">
            <small class="form-text text-muted">{% trans 'Number of days from when submitting phase starts until deadline (when job transitions to submitting state)' %}</small>
        </div>
        
        <div class="form-group">
            <label for="expired_date_days">{% trans 'Expired Date (Days)' %} *</label>
            <input type="number" id="expired_date_days" name="expired_date_days" min="1" value="{{ expired_date_days|default:14 }}" required aria-required="true">
            <small class="form-text text-muted">{% trans 'Number of days from now when the job will expire if no applications (in recruiting) or no submissions (in submitting) are received. Wallet contracts expire 7 days after this date.' %}</small>
        </div>
        
        <div class="form-group">
            {% include 'components/form_label_with_audio.html' with label_text="Optional reference media" slug="form_reference_media" field_id="reference_media" %}
            <p class="muted-text">{% trans 'Record audio or upload photos/videos so creators understand what you need even if they do not read the description.' %}</p>
            {% if job.reference_audio or job.reference_video or job.reference_image %}
                <p class="text-muted">{% trans 'Current files:' %}</p>
                <ul class="text-muted">
                    {% if job.reference_audio %}
                        <li>{% trans 'Audio' %}: <a href="{{ job.reference_audio.url }}" target="_blank">{% trans 'View' %}</a></li>
                    {% endif %}
                    {% if job.reference_video %}
                        <li>{% trans 'Video' %}: <a href="{{ job.reference_video.url }}" target="_blank">{% trans 'View' %}</a></li>
                    {% endif %}
                    {% if job.reference_image %}
                        <li>{% trans 'Image' %}: <a href="{{ job.reference_image.url }}" target="_blank">{% trans 'View' %}</a></li>
                    {% endif %}
                </ul>
                <p class="text-muted">{% trans 'Upload new files to replace existing ones.' %}</p>
            {% endif %}
        </div>
        
        <div class="reference-media-grid">
            <div class="form-group">
                {% include 'components/form_label_with_audio.html' with label_text="Audio instructions" slug="form_reference_audio" field_id="reference_audio" %}
                <div class="audio-recording-section" data-audio-recording data-file-input-id="reference_audio" data-max-duration="180000" data-compression-bitrate="192000">
                    <div class="recording-controls">
                        <button type="button" class="btn-record" id="btn-start-recording-audio" aria-label="{% trans 'Start recording' %}">
                            <span class="record-icon" aria-hidden="true">??</span>
                            <span class="record-label">{% trans 'Record Audio' %}</span>
                        </button>
                        <button type="button" class="btn-retry" id="btn-retry-recording-audio" style="display: none;" aria-label="{% trans 'Record again' %}">
                            <span class="retry-icon" aria-hidden="true">??</span>
                            <span class="retry-label">{% trans 'Record Again' %}</span>
                        </button>
                        <button type="button" class="btn-stop" id="btn-stop-recording-audio" style="display: none;" aria-label="{% trans 'Stop recording' %}">
                            <span class="stop-icon" aria-hidden="true">?</span>
                            <span class="stop-label">{% trans 'Stop' %}</span>
                        </button>
                        <button type="button" class="btn-cancel" id="btn-cancel-recording-audio" style="display: none;" aria-label="{% trans 'Cancel recording' %}">
                            <span class="cancel-icon" aria-hidden="true">?</span>
                            <span class="cancel-label">{% trans 'Cancel' %}</span>
                        </button>
                    </div>
                    <div class="recording-status" id="recording-status-audio" style="display: none;" role="status" aria-live="polite">
                        <span class="recording-indicator" aria-hidden="true">??</span>
                        <span class="recording-time" id="recording-time-audio">0:00</span>
                    </div>
                    <div class="recording-preview" id="recording-preview-audio" style="display: none;">
                        <audio controls id="recording-audio-preview-audio"></audio>
                    </div>
                </div>
                <p class="muted-text" style="font-size: 0.875rem; margin-top: 0.5rem;">
                    {% trans 'Or upload an audio file:' %}
                </p>
                <input type="file" id="reference_audio" name="reference_audio" accept="audio/*" capture="microphone">
            </div>
            
            <div class="form-group">
                {% include 'components/form_label_with_audio.html' with label_text="Video reference" slug="form_reference_video" field_id="reference_video" %}
                <input type="file" id="reference_video" name="reference_video" accept="video/*" capture="environment">
                <small class="form-text text-muted">{% trans 'Record with your camera or upload an existing clip.' %}</small>
            </div>
            
            <div class="form-group">
                {% include 'components/form_label_with_audio.html' with label_text="Image reference" slug="form_reference_image" field_id="reference_image" %}
                <input type="file" id="reference_image" name="reference_image" accept="image/*" capture="environment">
                <small class="form-text text-muted">{% trans 'Take a quick photo or upload inspiration images.' %}</small>
            </div>
        </div>
        
        <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1.5rem; align-items: center;">
            <button type="submit" name="save_draft" class="btn btn-secondary">{% trans 'Save Draft' %}</button>
            {% audio_player_static_ui "button_save_draft" "label" %}
            {% if job.status == 'draft' %}
                <button type="submit" name="publish" class="btn btn-primary">{% trans 'Publish Job' %}</button>
                {% audio_player_static_ui "button_publish_job" "label" %}
            {% else %}
                <button type="submit" name="publish" class="btn btn-primary">{% trans 'Update Job' %}</button>
                {% audio_player_static_ui "button_update_job" "label" %}
            {% endif %}
            <a href="{% url 'jobs:owner_dashboard' %}" class="btn btn-secondary">{% trans 'Cancel' %}</a>
            {% audio_player_static_ui "button_cancel" "label" %}
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'audio/audio-recorder.js' %}"></script>
<script src="{% static 'jobs/job-submission-audio.js' %}"></script>
<script>
    // Calculate total budget dynamically
    function updateTotalBudget() {
        const amountPerPerson = parseFloat(document.getElementById('amount_per_person').value) || 0;
        const maxResponses = parseInt(document.getElementById('max_responses').value) || 1;
        const total = amountPerPerson * maxResponses;
        const display = document.getElementById('total-budget-display');
        if (display) {
            display.innerHTML = '<strong>' + total.toFixed(2) + ' pesos</strong>';
        }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        const amountInput = document.getElementById('amount_per_person');
        const responsesInput = document.getElementById('max_responses');
        
        if (amountInput) {
            amountInput.addEventListener('input', updateTotalBudget);
            amountInput.addEventListener('change', updateTotalBudget);
        }
        
        if (responsesInput) {
            responsesInput.addEventListener('input', updateTotalBudget);
            responsesInput.addEventListener('change', updateTotalBudget);
        }
        
        // Initial calculation
        updateTotalBudget();
    });
</script>
{% endblock %}
