{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans 'Job Owner Dashboard' %} - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
.job-owner-wrapper {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .job-owner-card {
        border-left: 4px solid #d1d5db;
    }

    .job-owner-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
    }

    .status-pill {
        padding: 0.25rem 0.75rem;
        border-radius: 999px;
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: capitalize;
    }


    .submission-list {
        margin-top: 1rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .submission-card {
        padding: 0.75rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        background-color: #f9fafb;
    }

    .submission-card.accepted {
        border-color: #bbf7d0;
        background-color: #ecfdf5;
    }

    .submission-card.pending {
        border-color: #fde68a;
        background-color: #fffbeb;
    }

    .submission-card.rejected {
        border-color: #fecaca;
        background-color: #fef2f2;
    }

.submission-files {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .download-chip {
        font-size: 0.85rem;
        border-radius: 999px;
        border: 1px solid #d1d5db;
        padding: 0.25rem 0.75rem;
        background-color: #fff;
        text-decoration: none;
        color: #1f2937;
    }

    .download-chip:hover,
    .download-chip:focus {
        border-color: #9ca3af;
        color: #111827;
    }

.job-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        margin-top: 1rem;
    }

    .job-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
    }

    .status-pending { background-color: #fef3c7; color: #92400e; }
    .status-accepted { background-color: #dcfce7; color: #166534; }
    .status-rejected { background-color: #fee2e2; color: #991b1b; }
    .status-draft { background-color: #fef3c7; color: #92400e; }
    .status-recruiting { background-color: #dbeafe; color: #1d4ed8; }
    .status-selecting { background-color: #f3e8ff; color: #6d28d9; }
    .status-submitting { background-color: #fef3c7; color: #b45309; }
    .status-reviewing { background-color: #fef3c7; color: #b45309; }
    .status-expired { background-color: #fee2e2; color: #b91c1c; }
    .status-complete { background-color: #dcfce7; color: #15803d; }
</style>
{% endblock %}

{% block content %}
{% load audio_tags %}
{% include 'components/static_title_with_audio.html' with title_text="Job Owner Dashboard" slug="page_job_owner_dashboard" heading_tag="h1" %}
<p class="text-muted">{% trans 'Review progress, download deliverables, and mark jobs as complete once you are satisfied.' %}</p>

{% if not has_jobs %}
    <div class="card">
        <p>{% trans 'You have not created any jobs yet.' %}</p>
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            <a href="{% url 'jobs:create' %}" class="btn btn-primary">{% trans 'Create a Job' %}</a>
            {% audio_player_static_ui "button_create_job" "label" %}
        </div>
    </div>
{% else %}
    {% if drafts %}
        {% load audio_tags %}
        {% include 'components/static_title_with_audio.html' with title_text="Drafts" slug="section_drafts" heading_tag="h2" %}
        <div class="job-owner-wrapper">
            {% for job in drafts %}
                <section class="card job-owner-card" aria-labelledby="job-{{ job.pk }}">
                    <div class="job-owner-header">
                        <div>
                            {% include 'components/title_with_audio.html' with title=job.title content_object=job field_name="title" heading_tag="h2" %}
                            <p class="text-muted" style="margin: 0;">{% trans 'Created' %}: {{ job.created_at|date:"F d, Y" }}</p>
                        </div>
                        <span class="status-pill status-{{ job.status }}">
                            {{ job.get_status_display }}
                        </span>
                    </div>

                    <div class="job-grid">
                        <div>
                            <p><strong>{% trans 'Budget' %}:</strong> {{ job.budget }} pesos</p>
                            <p><strong>{% trans 'Amount Per Person' %}:</strong> {{ job.amount_per_person }} pesos</p>
                        </div>
                    </div>

                    <div class="job-actions">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <a href="{% url 'jobs:edit' job.pk %}" class="btn btn-primary">{% trans 'Edit Draft' %}</a>
                            {% audio_player_static_ui "button_edit_draft" "label" %}
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <a href="{% url 'jobs:detail' job.pk %}" class="btn btn-secondary">{% trans 'Preview' %}</a>
                            {% audio_player_static_ui "button_preview" "label" %}
                        </div>
                    </div>
                </section>
            {% endfor %}
        </div>
    {% endif %}

    {% if published_jobs %}
        <h2 style="margin-top: 2rem;">{% trans 'Published Jobs' %}</h2>
        <div class="job-owner-wrapper">
            {% for job in published_jobs %}
                <section class="card job-owner-card" aria-labelledby="job-{{ job.pk }}">
                    <div class="job-owner-header">
                        <div>
                            {% include 'components/title_with_audio.html' with title=job.title content_object=job field_name="title" heading_tag="h2" heading_id="job-"|add:job.pk link_url_name="jobs:detail" link_url_arg=job.pk %}
                            <p class="text-muted" style="margin: 0;">{% trans 'Created' %}: {{ job.created_at|date:"F d, Y" }}</p>
                        </div>
                        <span class="status-pill status-{{ job.status }}">
                            {{ job.get_status_display }}
                        </span>
                    </div>

                    <div class="job-grid">
                        <div>
                            <p><strong>{% trans 'Budget' %}:</strong> {{ job.budget }} pesos</p>
                            <p><strong>{% trans 'Amount Per Person' %}:</strong> {{ job.amount_per_person }} pesos</p>
                        </div>
                        <div>
                            <p><strong>{% trans 'Progress' %}:</strong> {{ job.accepted_submissions }} / {{ job.max_responses }} {% trans 'accepted' %}</p>
                            <p><strong>{% trans 'Pending reviews' %}:</strong> {{ job.pending_submissions }}</p>
                            <p><strong>{% trans 'Total submissions' %}:</strong> {{ job.total_submissions }}</p>
                        </div>
                    </div>

                    <div class="job-actions">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <a href="{% url 'jobs:detail' job.pk %}" class="btn btn-primary">{% trans 'View public page' %}</a>
                            {% audio_player_static_ui "button_view_public_page" "label" %}
                        </div>
                        {% if job.status == 'recruiting' %}
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <a href="{% url 'jobs:edit' job.pk %}" class="btn btn-secondary">{% trans 'Edit' %}</a>
                                {% audio_player_static_ui "button_edit" "label" %}
                            </div>
                        {% endif %}
                        {% if job.can_complete_contract %}
                            <form method="post" action="{% url 'jobs:complete_contract' job.pk %}" style="display: inline;">
                                {% csrf_token %}
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <button type="submit" class="btn btn-success">{% trans 'Complete Contract' %}</button>
                                    {% audio_player_static_ui "button_complete_contract" "label" %}
                                </div>
                            </form>
                        {% elif job.status == 'complete' %}
                            <span class="text-success">{% trans 'Job is completed' %}</span>
                        {% endif %}
                    </div>

                    <div class="submission-list">
                        {% load audio_tags %}
                        {% include 'components/static_title_with_audio.html' with title_text="Submissions" slug="section_submissions_list" heading_tag="h3" %}
                        {% if job.submissions.all %}
                            {% for submission in job.submissions.all %}
                                <div class="submission-card {{ submission.status }}">
                                    <div style="display:flex;justify-content:space-between;flex-wrap:wrap;gap:0.5rem;">
                                        <div>
                                            <strong>{{ submission.creator.get_display_name }}</strong>
                                            <p class="text-muted" style="margin:0;">{{ submission.created_at|date:"F d, Y H:i" }}</p>
                                        </div>
                                        <span class="status-pill status-{{ submission.status }}">
                                            {{ submission.get_status_display }}
                                        </span>
                                    </div>
                                    {% if submission.status == 'pending' %}
                                        <div style="display: inline-flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;">
                                            <a href="{% url 'jobs:accept_submission' job.pk submission.pk %}" class="btn btn-success">{% trans 'Accept' %}</a>
                                            {% audio_player_static_ui "button_accept" "label" %}
                                            <a href="{% url 'jobs:decline_submission' job.pk submission.pk %}" class="btn btn-danger">{% trans 'Decline' %}</a>
                                            {% audio_player_static_ui "button_decline" "label" %}
                                        </div>
                                    {% endif %}
                                    {% if submission.note %}
                                        <p style="margin-top:0.5rem;">{{ submission.note }}</p>
                                    {% endif %}
                                    {% if submission.text_content %}
                                        <div style="margin-top:0.5rem;">
                                            <p><strong>{% trans 'Text Content' %}:</strong></p>
                                            <div style="background-color: #f5f5f5; padding: 1rem; border-radius: 0.5rem; white-space: pre-wrap;">{{ submission.text_content }}</div>
                                        </div>
                                    {% endif %}
                                    {% if submission.text_file or submission.audio_file or submission.video_file or submission.image_file %}
                                        <div class="submission-files">
                                            {% if submission.text_file %}
                                                <div style="display: inline-flex; align-items: center; gap: 0.5rem;">
                                                    <a href="{{ submission.text_file.url }}" class="download-chip" download>
                                                        {% trans 'Download text' %}
                                                    </a>
                                                    {% audio_player_static_ui "button_download_text" "label" %}
                                                </div>
                                            {% endif %}
                                            {% if submission.audio_file %}
                                                <div style="display: inline-flex; align-items: center; gap: 0.5rem;">
                                                    <a href="{{ submission.audio_file.url }}" class="download-chip" download>
                                                        {% trans 'Download audio' %}
                                                    </a>
                                                    {% audio_player_static_ui "button_download_audio" "label" %}
                                                </div>
                                            {% endif %}
                                            {% if submission.video_file %}
                                                <div style="display: inline-flex; align-items: center; gap: 0.5rem;">
                                                    <a href="{{ submission.video_file.url }}" class="download-chip" download>
                                                        {% trans 'Download video' %}
                                                    </a>
                                                    {% audio_player_static_ui "button_download_video" "label" %}
                                                </div>
                                            {% endif %}
                                            {% if submission.image_file %}
                                                <div style="display: inline-flex; align-items: center; gap: 0.5rem;">
                                                    <a href="{{ submission.image_file.url }}" class="download-chip" download>
                                                        {% trans 'Download image' %}
                                                    </a>
                                                    {% audio_player_static_ui "button_download_image" "label" %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <p class="text-muted" style="margin-top:0.5rem;">{% trans 'No files attached.' %}</p>
                                    {% endif %}
                                </div>
                            {% empty %}
                                <p class="text-muted">{% trans 'No submissions yet.' %}</p>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">{% trans 'No submissions yet.' %}</p>
                        {% endif %}
                    </div>
                </section>
            {% endfor %}
        </div>
    {% endif %}
{% endif %}
{% endblock %}
