{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans 'Browse Jobs' %} - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
    .filter-options {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 1rem;
        margin: 0;
    }
    
    .filter-options legend {
        font-weight: 600;
        padding: 0 0.5rem;
        margin-bottom: 0.5rem;
    }
    
    .checkbox-group {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    
    .checkbox-group label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: normal;
        margin-bottom: 0;
        cursor: pointer;
    }
    
    .checkbox-group input[type="checkbox"] {
        width: auto;
        margin: 0;
        cursor: pointer;
        flex-shrink: 0;
    }
    
    .job-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
    }
    
    .job-tag {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .job-tag.applied {
        background-color: #dbeafe;
        color: #1e40af;
    }
    
    .job-tag.deadline-soon {
        background-color: #fef3c7;
        color: #92400e;
    }
    
    .job-count-info {
        margin-top: 0.5rem;
        padding: 0.5rem;
        background-color: #f3f4f6;
        border-radius: 4px;
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block content %}
{% load audio_tags %}
{% include 'components/static_title_with_audio.html' with title_text="Available Jobs" slug="page_available_jobs" heading_tag="h1" %}

{% if user.is_authenticated and waiting_for_submission %}
    <div class="card" style="border-left: 4px solid #f59e0b; margin-bottom: 1.5rem;">
        {% load audio_tags %}
        {% include 'components/static_title_with_audio.html' with title_text="Jobs Waiting for Your Submission" slug="section_waiting_for_submission" heading_tag="h2" %}
        <style>
            #section_waiting_for_submission {
                margin-top: 0;
                color: #b45309;
            }
        </style>
        <p>{% trans 'You\'ve been selected for these jobs. Submit your work now!' %}</p>
        <div role="list" aria-label="{% trans 'Jobs waiting for submission' %}">
            {% for job in waiting_for_submission %}
                <article class="card" role="listitem" style="margin-top: 1rem;">
                    {% include 'components/title_with_audio.html' with title=job.title content_object=job field_name="title" heading_tag="h3" link_url_name="jobs:detail" link_url_arg=job.pk %}
                    <p><strong>{% trans 'Language' %}:</strong> {{ job.target_language }}</p>
                    <p><strong>{% trans 'Amount Per Person' %}:</strong> {{ job.amount_per_person }} ILP</p>
                    <p>{{ job.description|truncatewords:30 }}</p>
                    <a href="{% url 'jobs:submit' job.pk %}" class="btn btn-primary">{% trans 'Submit Work Now' %}</a>
                </article>
            {% endfor %}
        </div>
    </div>
{% endif %}

<div class="card">
    <form method="get" action="{% url 'jobs:list' %}" role="search">
        <div class="form-group">
            {% include 'components/form_label_with_audio.html' with label_text="Search Jobs" slug="form_search_jobs" field_id="search" %}
            <input type="text" id="search" name="search" value="{{ search_query }}" placeholder="{% trans 'Search by title or description...' %}">
        </div>
        <div class="form-group">
            {% include 'components/form_label_with_audio.html' with label_text="Filter by Language" slug="form_filter_language" field_id="language" %}
            <select id="language" name="language">
                <option value="">{% trans 'All Languages' %}</option>
                <option value="en" {% if language_filter == 'en' %}selected{% endif %}>English</option>
                <option value="es" {% if language_filter == 'es' %}selected{% endif %}>Spanish</option>
                <option value="nah" {% if language_filter == 'nah' %}selected{% endif %}>Nahuatl</option>
                <option value="oto" {% if language_filter == 'oto' %}selected{% endif %}>Otomi</option>
                <option value="maz" {% if language_filter == 'maz' %}selected{% endif %}>Mazahua</option>
                <option value="que" {% if language_filter == 'que' %}selected{% endif %}>Quechua</option>
            </select>
        </div>
        {% if user.is_authenticated %}
        <div class="form-group">
            <fieldset class="filter-options">
                <legend style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                    {% trans 'Filter Options' %}
                    {% audio_player_static_ui "section_filter_options" "label" %}
                </legend>
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" name="hide_applied" {% if hide_applied %}checked{% endif %}>
                        {% trans 'Hide jobs I\'ve applied to' %}
                    </label>
                </div>
            </fieldset>
        </div>
        {% endif %}
        <button type="submit" class="btn btn-primary">{% trans 'Filter' %}</button>
    </form>
</div>

{% if jobs %}
    <div role="list" aria-label="{% trans 'Job listings' %}">
        {% for job_item in jobs %}
            {% with job=job_item.job %}
            <article class="card" role="listitem">
                <div class="job-tags">
                    {% if job_item.has_applied %}
                        <span class="job-tag applied">{% trans 'Applied' %}</span>
                    {% endif %}
                    {% if job_item.deadline_soon %}
                        <span class="job-tag deadline-soon">{% trans 'About to Start' %}</span>
                    {% endif %}
                </div>
                
                {% include 'components/title_with_audio.html' with title=job.title content_object=job field_name="title" heading_tag="h2" link_url_name="jobs:detail" link_url_arg=job.pk %}
                <p><strong>{% trans 'Language' %}:</strong> {{ job.target_language }}</p>
                {% if job.target_dialect %}
                    <p><strong>{% trans 'Dialect' %}:</strong> {{ job.target_dialect }}</p>
                {% endif %}
                <p><strong>{% trans 'Amount Per Person' %}:</strong> {{ job.amount_per_person }} ILP</p>
                <p><strong>{% trans 'Total Budget' %}:</strong> {{ job.budget }} ILP</p>
                <p><strong>{% trans 'Status' %}:</strong> {{ job.get_status_display }}</p>
                
                {% if job.status == 'recruiting' or job.status == 'open' %}
                    <div class="job-count-info">
                        <strong>{% trans 'Applications' %}:</strong> {{ job.applications_count }} / {{ job.recruit_limit }} {% trans 'needed' %}
                    </div>
                {% elif job.status == 'submitting' %}
                    <div class="job-count-info">
                        <strong>{% trans 'Workers Submitted' %}:</strong> {{ job.submissions_count }} / {{ job.max_responses }} {% trans 'needed' %}
                    </div>
                {% endif %}
                
                <p><strong>{% trans 'Deliverables' %}:</strong> {{ job.get_deliverable_types_display }}</p>
                <p>{{ job.description|truncatewords:30 }}</p>
                <a href="{% url 'jobs:detail' job.pk %}" class="btn btn-primary">{% trans 'View Details' %}</a>
            </article>
            {% endwith %}
        {% endfor %}
    </div>
{% else %}
    <div class="card">
        <p>{% trans 'No jobs available at the moment.' %}</p>
    </div>
{% endif %}
{% endblock %}
