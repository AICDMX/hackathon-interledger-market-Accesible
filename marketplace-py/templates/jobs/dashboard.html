{% extends 'base.html' %}
{% load i18n static %}

{% block title %}{% trans 'Dashboard' %}{% endblock %}

{% block extra_css %}
<style>
    .dashboard-container {
        max-width: 100%;
        margin: 0;
        padding: 1rem;
        min-height: calc(100vh - 200px);
        box-sizing: border-box;
        overflow-x: hidden;
        width: 100%;
    }

    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        padding: 0;
        width: 100%;
        box-sizing: border-box;
    }

    .dashboard-icon-card {
        background-color: #fff;
        border-radius: 16px;
        padding: 2rem 1rem;
        text-align: center;
        text-decoration: none;
        color: #333;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 160px;
        border: 2px solid transparent;
        box-sizing: border-box;
        width: 100%;
        overflow: hidden;
    }

    .dashboard-icon-card:hover,
    .dashboard-icon-card:focus {
        transform: translateY(-4px);
        box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
        border-color: #3498db;
        outline: none;
    }

    .dashboard-icon-card:active {
        transform: translateY(-2px);
    }

    .dashboard-icon {
        font-size: 4rem;
        margin-bottom: 0.75rem;
        line-height: 1;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .dashboard-icon img {
        max-width: 100%;
        height: auto;
        object-fit: contain;
    }

        .dashboard-label {
            font-size: 1rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            flex-wrap: wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
            width: 100%;
            box-sizing: border-box;
        }

        .dashboard-audio-wrapper {
            display: inline-flex;
            align-items: center;
            margin-left: 0.5rem;
            vertical-align: middle;
        }

    /* Tablet and up: 3 columns */
    @media (min-width: 600px) {
        .dashboard-grid {
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
        }

        .dashboard-icon-card {
            min-height: 180px;
            padding: 2.5rem 1rem;
        }

        .dashboard-icon {
            font-size: 5rem;
        }

        .dashboard-label {
            font-size: 1.1rem;
        }
    }

    /* Desktop: 3 columns with more spacing */
    @media (min-width: 1024px) {
        .dashboard-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
        }

        .dashboard-grid {
            gap: 2rem;
        }

        .dashboard-icon-card {
            min-height: 200px;
            padding: 3rem 1.5rem;
        }

        .dashboard-icon {
            font-size: 6rem;
        }

        .dashboard-label {
            font-size: 1.25rem;
        }
    }

    /* Ensure proper touch targets on mobile */
    @media (max-width: 599px) {
        .dashboard-icon-card {
            min-height: 140px;
            padding: 1.5rem 1rem;
        }

        .dashboard-icon {
            font-size: 3.5rem;
        }
    }

    .audio-info-banner {
        position: fixed;
        bottom: 1.5rem;
        left: 50%;
        transform: translate(-50%, 20px);
        background: rgba(44, 62, 80, 0.95);
        color: #fff;
        padding: 0.5rem 1.25rem;
        border-radius: 999px;
        font-size: 0.9rem;
        box-shadow: 0 4px 14px rgba(0, 0, 0, 0.2);
        opacity: 0;
        pointer-events: auto;
        transition: opacity 0.25s ease, transform 0.25s ease;
        z-index: 1000;
        display: inline-flex;
        align-items: center;
        gap: 0.75rem;
    }

    .audio-info-banner.show {
        opacity: 1;
        transform: translate(-50%, 0);
    }

    .audio-info-action {
        background: #f1c40f;
        color: #2c3e50;
        border: none;
        border-radius: 20px;
        padding: 0.3rem 0.9rem;
        font-size: 0.85rem;
        font-weight: 600;
        text-decoration: none;
        cursor: pointer;
        transition: background 0.2s ease;
        white-space: nowrap;
    }

    .audio-info-action:hover,
    .audio-info-action:focus {
        background: #f39c12;
        color: #fff;
    }

    .audio-info-close {
        background: transparent;
        border: none;
        color: #fff;
        font-size: 1.5rem;
        line-height: 1;
        cursor: pointer;
        padding: 0;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background-color 0.2s ease;
        margin-left: 0.5rem;
        flex-shrink: 0;
    }

    .audio-info-close:hover,
    .audio-info-close:focus {
        background-color: rgba(255, 255, 255, 0.2);
        outline: 2px solid rgba(255, 255, 255, 0.5);
        outline-offset: 2px;
    }
</style>
{% endblock %}

{% block content %}
{% load audio_tags %}
<div class="dashboard-container">
    {% include 'components/static_title_with_audio.html' with title_text="Dashboard" slug="page_dashboard" heading_tag="h1" heading_id="dashboard-title" %}
    <style>
        #dashboard-title {
            text-align: center;
            margin-bottom: 2rem;
            color: #2c3e50;
        }
    </style>
    
    <div class="dashboard-grid" role="grid" aria-label="{% trans 'Main navigation' %}">
        {% if user.is_funder %}
        <a href="{% url 'jobs:create' %}" class="dashboard-icon-card" role="gridcell" aria-label="{% trans 'Post Job' %}">
            <div class="dashboard-icon" aria-hidden="true">
                <img src="/media/available-jobs.png" alt="{% trans 'Job Post' %}" style="width: 5rem; height: 5rem; object-fit: contain;" loading="lazy" />
            </div>
            <p class="dashboard-label">
                {% trans 'Job Post' %}
                {% with audio_target=audio_targets.job_post %}
                <span class="dashboard-audio-wrapper" 
                      data-audio-target="label"
                      data-content-type="dashboard"
                      data-object-id="job_post"
                      data-language="{{ preferred_audio_language|default:LANGUAGE_CODE }}"
                      data-support-url="{{ audio_target.support_url }}"
                      data-support-message="{{ audio_target.description_es }}"
                      data-support-needs-funding="{{ audio_target.needs_funding|yesno:'true,false' }}"
                      data-support-language="{{ audio_target.language_code }}">
                </span>
                {% endwith %}
            </p>
        </a>

        {% if has_posted_jobs %}
        <a href="{% url 'jobs:owner_dashboard' %}" class="dashboard-icon-card" role="gridcell" aria-label="{% trans 'Manage My Jobs' %}">
            <div class="dashboard-icon" aria-hidden="true">??</div>
            <p class="dashboard-label">
                {% trans 'My Job Dashboard' %}
            </p>
        </a>
        {% endif %}
        {% endif %}

        <a href="{% url 'jobs:my_products' %}" class="dashboard-icon-card" role="gridcell" aria-label="{% trans 'My Products' %}">
            <div class="dashboard-icon" aria-hidden="true">
                <img src="/media/my-products.png" alt="{% trans 'My Products' %}" style="width: 5rem; height: 5rem; object-fit: contain;" loading="lazy" />
            </div>
            <p class="dashboard-label">
                {% trans 'My Products' %}
                {% with audio_target=audio_targets.my_products %}
                <span class="dashboard-audio-wrapper" 
                      data-audio-target="label"
                      data-content-type="dashboard"
                      data-object-id="my_products"
                      data-language="{{ preferred_audio_language|default:LANGUAGE_CODE }}"
                      data-support-url="{{ audio_target.support_url }}"
                      data-support-message="{{ audio_target.description_es }}"
                      data-support-needs-funding="{{ audio_target.needs_funding|yesno:'true,false' }}"
                      data-support-language="{{ audio_target.language_code }}">
                </span>
                {% endwith %}
            </p>
        </a>

        <a href="{% url 'jobs:my_money' %}" class="dashboard-icon-card" role="gridcell" aria-label="{% trans 'My Money' %}">
            <div class="dashboard-icon" aria-hidden="true">
                <img src="/media/my-money.png" alt="{% trans 'My Money' %}" loading="lazy" />
            </div>
            <p class="dashboard-label">
                {% trans 'My Money' %}
                {% with audio_target=audio_targets.my_money %}
                <span class="dashboard-audio-wrapper" 
                      data-audio-target="label"
                      data-content-type="dashboard"
                      data-object-id="my_money"
                      data-language="{{ preferred_audio_language|default:LANGUAGE_CODE }}"
                      data-support-url="{{ audio_target.support_url }}"
                      data-support-message="{{ audio_target.description_es }}"
                      data-support-needs-funding="{{ audio_target.needs_funding|yesno:'true,false' }}"
                      data-support-language="{{ audio_target.language_code }}">
                </span>
                {% endwith %}
            </p>
        </a>

        {% if user.is_creator %}
        <a href="{% url 'jobs:pending_jobs' %}" class="dashboard-icon-card" role="gridcell" aria-label="{% trans 'Pending Jobs' %}">
            <div class="dashboard-icon" aria-hidden="true">
                <img src="/media/my-pending-to-do.png" alt="{% trans 'My Pending to Finish Jobs' %}" loading="lazy" />
            </div>
            <p class="dashboard-label">
                {% trans 'My Pending to Finish Jobs' %}
                {% with audio_target=audio_targets.pending_jobs %}
                <span class="dashboard-audio-wrapper" 
                      data-audio-target="label"
                      data-content-type="dashboard"
                      data-object-id="pending_jobs"
                      data-language="{{ preferred_audio_language|default:LANGUAGE_CODE }}"
                      data-support-url="{{ audio_target.support_url }}"
                      data-support-message="{{ audio_target.description_es }}"
                      data-support-needs-funding="{{ audio_target.needs_funding|yesno:'true,false' }}"
                      data-support-language="{{ audio_target.language_code }}">
                </span>
                {% endwith %}
            </p>
        </a>
        {% endif %}

        <a href="{% url 'jobs:filler_1' %}" class="dashboard-icon-card" role="gridcell" aria-label="{% trans 'Page 1' %}">
            <div class="dashboard-icon" aria-hidden="true">
                <img src="/media/watch-video.png" alt="{% trans 'Page 1' %}" style="width: 5rem; height: 5rem; object-fit: contain;" loading="lazy" />
            </div>
            <p class="dashboard-label">
                {% trans 'Page 1' %}
                {% with audio_target=audio_targets.page_1 %}
                <span class="dashboard-audio-wrapper" 
                      data-audio-target="label"
                      data-content-type="dashboard"
                      data-object-id="page_1"
                      data-language="{{ preferred_audio_language|default:LANGUAGE_CODE }}"
                      data-support-url="{{ audio_target.support_url }}"
                      data-support-message="{{ audio_target.description_es }}"
                      data-support-needs-funding="{{ audio_target.needs_funding|yesno:'true,false' }}"
                      data-support-language="{{ audio_target.language_code }}">
                </span>
                {% endwith %}
            </p>
        </a>

        <a href="{% url 'jobs:filler_2' %}" class="dashboard-icon-card" role="gridcell" aria-label="{% trans 'Page 2' %}">
            <div class="dashboard-icon" aria-hidden="true">
                <img src="{{ audio_config.icon_active }}" alt="{% trans 'Page 2' %}" loading="lazy" />
            </div>
            <p class="dashboard-label">
                {% trans 'Page 2' %}
                {% with audio_target=audio_targets.page_2 %}
                <span class="dashboard-audio-wrapper" 
                      data-audio-target="label"
                      data-content-type="dashboard"
                      data-object-id="page_2"
                      data-language="{{ preferred_audio_language|default:LANGUAGE_CODE }}"
                      data-support-url="{{ audio_target.support_url }}"
                      data-support-message="{{ audio_target.description_es }}"
                      data-support-needs-funding="{{ audio_target.needs_funding|yesno:'true,false' }}"
                      data-support-language="{{ audio_target.language_code }}">
                </span>
                {% endwith %}
            </p>
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'audio/audio-player.js' %}"></script>
<script>
// Initialize audio players for dashboard items
// Note: To use audio for dashboard items, create AudioSnippet entries in Django admin
// You'll need a ContentType for dashboard items (or use an existing model)
document.addEventListener('DOMContentLoaded', function() {
    const audioMessages = {
        error: 'No pudimos reproducir el audio. Int?ntalo de nuevo o sube uno nuevo.',
        notAvailable: 'A?n no tenemos audio para este bot?n.',
        moduleMissing: 'El reproductor todav?a no est? listo en este dispositivo.',
        notConfigured: 'Conecta este bot?n con un contenido para habilitar el audio.'
    };
    // Load audio configuration and core module
    window.AUDIO_CONFIG = {
        iconInactive: '{{ audio_config.icon_inactive }}',
        iconActive: '{{ audio_config.icon_active }}',
        fallbackAudio: {{ audio_config.fallback_audio|safe }},
        fallbackFile: '{{ audio_config.fallback_file }}',
        staticUrl: '{{ audio_config.static_url }}'
    };
    // Load the centralized audio player module
    const script = document.createElement('script');
    script.src = '{% static "audio/audio-player-core.js" %}';
    document.head.appendChild(script);
    
    const defaultFundAmount = {{ community_fund_amount|default:10 }};

    const audioInfoBanner = document.createElement('div');
    audioInfoBanner.className = 'audio-info-banner';
    audioInfoBanner.setAttribute('role', 'status');
    audioInfoBanner.setAttribute('aria-live', 'polite');
    audioInfoBanner.setAttribute('aria-atomic', 'true');
    document.body.appendChild(audioInfoBanner);

    let audioInfoTimeoutId = null;
    let fallbackAudioInstance = null;
    
    function closeAudioBanner() {
        if (audioInfoTimeoutId) {
            clearTimeout(audioInfoTimeoutId);
            audioInfoTimeoutId = null;
        }
        audioInfoBanner.classList.remove('show');
    }
    
    function showAudioMessage(message, options = {}) {
        const { actions = [], playFallback } = options;
        audioInfoBanner.innerHTML = '';
        const textSpan = document.createElement('span');
        textSpan.textContent = message;
        audioInfoBanner.appendChild(textSpan);

        actions.forEach(action => {
            if (!action.url) {
                return;
            }
            const actionLink = document.createElement('a');
            actionLink.className = 'audio-info-action';
            actionLink.href = action.url;
            actionLink.textContent = action.label || 'Ver';
            actionLink.setAttribute('role', 'button');
            if (action.target) {
                actionLink.target = action.target;
                if (action.target === '_blank') {
                    actionLink.rel = 'noopener noreferrer';
                }
            }
            audioInfoBanner.appendChild(actionLink);
        });

        // Add close button
        const closeButton = document.createElement('button');
        closeButton.className = 'audio-info-close';
        closeButton.innerHTML = '&times;';
        closeButton.setAttribute('aria-label', '{% trans "Close" %}');
        closeButton.setAttribute('type', 'button');
        closeButton.onclick = closeAudioBanner;
        audioInfoBanner.appendChild(closeButton);

        audioInfoBanner.classList.add('show');
        if (audioInfoTimeoutId) {
            clearTimeout(audioInfoTimeoutId);
        }
        audioInfoTimeoutId = setTimeout(function() {
            closeAudioBanner();
        }, 30000);

        if (playFallback) {
            playFallbackAudio();
        }
    }

    function playFallbackAudio() {
        if (!fallbackAudioUrl) {
            return;
        }
        if (!fallbackAudioInstance) {
            fallbackAudioInstance = new Audio(fallbackAudioUrl);
        }
        fallbackAudioInstance.currentTime = 0;
        fallbackAudioInstance.play().catch(() => {});
    }

    function buildSupportActions(wrapper) {
        if (!wrapper) {
            return [];
        }
        const supportUrl = wrapper.dataset.supportUrl;
        if (!supportUrl) {
            return [];
        }
        const needsFunding = wrapper.dataset.supportNeedsFunding === 'true';
        const actions = [{
            label: 'Subir audio',
            url: `${supportUrl}#upload-audio`,
        }];
        if (needsFunding) {
            actions.unshift({
                label: `Fondear (${defaultFundAmount} pesos)`,
                url: `${supportUrl}#funding`,
            });
        }
        return actions;
    }

    function showSupportBanner(wrapper, options = {}) {
        const { message, playFallback = true } = options;
        const finalMessage = message || (wrapper && wrapper.dataset.supportMessage) || audioMessages.notAvailable;
        const actions = buildSupportActions(wrapper);
        showAudioMessage(finalMessage, {
            actions,
            playFallback,
        });
    }

    // These will be populated once you set up ContentType IDs
    // You can find ContentType IDs in Django admin under Content Types
    // For now, we'll create buttons that will work once audio is set up
    
    document.querySelectorAll('.dashboard-audio-wrapper').forEach(function(wrapper) {
        const objectIdStr = wrapper.dataset.objectId;
        const targetField = wrapper.dataset.audioTarget;
        const languageCode = wrapper.dataset.language || '{{ preferred_audio_language|default:LANGUAGE_CODE }}';
        
        // Create audio player button
        const audioBtn = document.createElement('button');
        audioBtn.type = 'button';
        audioBtn.className = 'audio-play-btn';
        audioBtn.style.cssText = 'display: inline-flex; align-items: center; justify-content: center; padding: 0.25rem; background-color: transparent; border: none; cursor: pointer; transition: opacity 0.2s;';
        const audioIcon = document.createElement('img');
        audioIcon.src = window.AUDIO_CONFIG.iconInactive || '/media/listen-inactive.png';
        audioIcon.alt = '{% trans "Listen" %}';
        audioIcon.className = 'audio-icon';
        audioIcon.style.cssText = 'width: 32px; height: 32px; object-fit: contain; display: block;';
        audioIcon.setAttribute('aria-hidden', 'true');
        audioBtn.appendChild(audioIcon);
        audioBtn.setAttribute('aria-label', '{% trans "Play audio" %}');
        
        // Store data attributes for API calls
        wrapper.dataset.contentTypeId = ''; // Will be set when ContentType is created
        wrapper.dataset.objectIdNum = objectIdStr;
        
        audioBtn.onclick = function(e) {
            e.stopPropagation(); // Prevent link navigation
            e.preventDefault();
            
            // Try to use the audio player module if available
            if (window.audioPlayerModule) {
                // The audio player module will handle loading audio via API
                // For now, show that audio can be added via admin
                const contentTypeId = wrapper.dataset.contentTypeId;
                if (contentTypeId) {
                    // Try to load audio via API
                    const apiUrl = `/api/audio/snippets/get/${contentTypeId}/${objectIdStr}/${targetField}/${languageCode}/`;
                    fetch(apiUrl)
                        .then(response => {
                            if (response.ok) {
                                return response.json();
                            }
                            return null;
                        })
                        .then(data => {
                            if (data && data.audio_url) {
                                // Audio exists - play it
                                audioIcon.src = '/media/listen-active.png';
                                const audio = new Audio(data.audio_url);
                                audio.addEventListener('ended', function() {
                                    audioIcon.src = '/media/listen-inactive.png';
                                }, { once: true });
                                audio.play().then(() => {
                                    // Playing successfully
                                }).catch(() => {
                                    audioIcon.src = '/media/listen-inactive.png';
                                    // If main audio fails, try fallback
                                    if (data.fallback_audio_url) {
                                        const fallbackAudio = new Audio(data.fallback_audio_url);
                                        audioIcon.src = '/media/listen-active.png';
                                        fallbackAudio.addEventListener('ended', function() {
                                            audioIcon.src = '/media/listen-inactive.png';
                                        });
                                        fallbackAudio.play().catch(() => {
                                            audioIcon.src = '/media/listen-inactive.png';
                                            showSupportBanner(wrapper);
                                        });
                                    } else {
                                        showSupportBanner(wrapper);
                                    }
                                });
                            } else if (data && data.fallback_audio_url) {
                                // Use fallback audio
                                audioIcon.src = '/media/listen-active.png';
                                const fallbackAudio = new Audio(data.fallback_audio_url);
                                fallbackAudio.addEventListener('ended', function() {
                                    audioIcon.src = '/media/listen-inactive.png';
                                }, { once: true });
                                fallbackAudio.play().catch(() => {
                                    audioIcon.src = '/media/listen-inactive.png';
                                    showSupportBanner(wrapper);
                                });
                            } else {
                                // No audio - use fallback system
                                audioIcon.src = '/media/listen-active.png';
                                let fallbackPath = fallbackAudioUrl || '{% static "audio/fallback.mp3" %}';
                                if (languageCode === 'oto') {
                                    fallbackPath = '{% static "audio/fallback-oto.mp3" %}';
                                }
                                const fallbackAudio = new Audio(fallbackPath);
                                fallbackAudio.addEventListener('ended', function() {
                                    audioIcon.src = '/media/listen-inactive.png';
                                }, { once: true });
                                fallbackAudio.play().catch(() => {
                                    audioIcon.src = '/media/listen-inactive.png';
                                    showSupportBanner(wrapper);
                                });
                            }
                        })
                        .catch(() => {
                            // Try fallback on network error
                            audioIcon.src = '/media/listen-active.png';
                            let fallbackPath = fallbackAudioUrl || '{% static "audio/fallback.mp3" %}';
                            if (languageCode === 'oto') {
                                fallbackPath = '{% static "audio/fallback-oto.mp3" %}';
                            }
                            const fallbackAudio = new Audio(fallbackPath);
                            fallbackAudio.addEventListener('ended', function() {
                                audioIcon.src = '/media/listen-inactive.png';
                            }, { once: true });
                            fallbackAudio.play().catch(() => {
                                audioIcon.src = '/media/listen-inactive.png';
                                showSupportBanner(wrapper);
                            });
                        });
                } else {
                    showSupportBanner(wrapper);
                }
            } else {
                showSupportBanner(wrapper, { message: audioMessages.moduleMissing });
            }
        };
        
        wrapper.appendChild(audioBtn);
    });
});
</script>
{% endblock %}
