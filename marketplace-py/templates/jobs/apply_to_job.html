{% extends 'base.html' %}
{% load i18n static %}

{% block title %}{% trans 'Apply to Job' %} - {{ block.super }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'audio/audio-contribution.css' %}">
{% endblock %}

{% block content %}
{% load audio_tags %}
<div class="title-with-audio" style="display: flex; align-items: center; gap: 0.125rem; flex-wrap: wrap;">
    {% include 'components/static_title_with_audio.html' with title_text="Apply to Job" slug="page_apply_to_job" heading_tag="h1" %}
    <div style="display: flex; align-items: center; gap: 0.5rem;">
        <span>{{ job.title }}</span>
        {% audio_player job "title" %}
    </div>
</div>

<div class="card">
    <p><strong>{% trans 'Target Language' %}:</strong> {{ job.target_language }}</p>
    <p><strong>{% trans 'Budget' %}:</strong> {{ job.budget }} pesos</p>
    <p><strong>{% trans 'Amount Per Person' %}:</strong> {{ job.amount_per_person }} pesos</p>
    <p><strong>{% trans 'Required Deliverables' %}:</strong> {{ job.get_deliverable_types_display }}</p>
    <p>{{ job.description|linebreaks }}</p>
</div>

<div class="card">
    {% load audio_tags %}
    {% include 'components/static_title_with_audio.html' with title_text="Submit Your Profile" slug="section_submit_profile" heading_tag="h2" %}
    <p class="muted-text">{% trans 'Tell the job owner about yourself and why you are interested in this job. You can include audio, video, or image files to introduce yourself.' %}</p>
    {% if user.profile_note or user.profile_audio or user.profile_video or user.profile_image %}
    <div class="info-box" style="background-color: #e3f2fd; padding: 1rem; border-radius: 4px; margin-bottom: 1rem;">
        <p><strong>{% trans 'Auto-fill from profile' %}:</strong> {% trans 'Your profile information has been pre-filled below. You can edit it or leave it as is. If you don\'t upload new files, your profile files will be used automatically.' %}</p>
    </div>
    {% endif %}
    
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        
        <div class="form-group">
            {% include 'components/form_label_with_audio.html' with label_text="Profile Note" slug="form_profile_note" field_id=form.profile_note.id_for_label required=True %}
            {{ form.profile_note }}
            {% if form.profile_note.errors %}
                <div class="error">{{ form.profile_note.errors }}</div>
            {% endif %}
        </div>
        
        <div class="form-group">
            <label for="{{ form.profile_audio.id_for_label }}">{% trans 'Profile Audio (Optional)' %}</label>
            <div class="audio-recording-section" data-audio-recording data-file-input-id="{{ form.profile_audio.id_for_label }}">
                <div class="recording-controls">
                    <button type="button" class="btn-record" id="btn-start-recording-profile-audio" aria-label="{% trans 'Start recording' %}">
                        <span class="record-icon" aria-hidden="true">??</span>
                        <span class="record-label">{% trans 'Record Audio' %}</span>
                    </button>
                    <button type="button" class="btn-retry" id="btn-retry-recording-profile-audio" style="display: none;" aria-label="{% trans 'Record again' %}">
                        <span class="retry-icon" aria-hidden="true">??</span>
                        <span class="retry-label">{% trans 'Record Again' %}</span>
                    </button>
                    <button type="button" class="btn-stop" id="btn-stop-recording-profile-audio" style="display: none;" aria-label="{% trans 'Stop recording' %}">
                        <span class="stop-icon" aria-hidden="true">?</span>
                        <span class="stop-label">{% trans 'Stop' %}</span>
                    </button>
                    <button type="button" class="btn-cancel" id="btn-cancel-recording-profile-audio" style="display: none;" aria-label="{% trans 'Cancel recording' %}">
                        <span class="cancel-icon" aria-hidden="true">?</span>
                        <span class="cancel-label">{% trans 'Cancel' %}</span>
                    </button>
                </div>
                <div class="recording-status" id="recording-status-profile-audio" style="display: none;" role="status" aria-live="polite">
                    <span class="recording-indicator" aria-hidden="true">??</span>
                    <span class="recording-time" id="recording-time-profile-audio">0:00</span>
                </div>
                <div class="recording-preview" id="recording-preview-profile-audio" style="display: none;">
                    <audio controls id="recording-audio-preview-profile-audio"></audio>
                </div>
            </div>
            <p class="muted-text" style="font-size: 0.875rem; margin-top: 0.5rem;">
                {% trans 'Or upload an audio file:' %}
                {% if user.profile_audio %}
                    <br><small>{% trans 'Leave empty to use your profile audio:' %} <a href="{{ user.profile_audio.url }}" target="_blank">{% trans 'Listen' %}</a></small>
                {% endif %}
            </p>
            {{ form.profile_audio }}
            {% if form.profile_audio.errors %}
                <div class="error">{{ form.profile_audio.errors }}</div>
            {% endif %}
        </div>
        
        <div class="form-group">
            {% include 'components/form_label_with_audio.html' with label_text="Profile Video (Optional)" slug="form_profile_video" field_id=form.profile_video.id_for_label %}
            {{ form.profile_video }}
            <p class="muted-text" style="font-size: 0.875rem; margin-top: 0.5rem;">
                {% trans 'Record with your camera or upload an existing video.' %}
            </p>
            {% if form.profile_video.errors %}
                <div class="error">{{ form.profile_video.errors }}</div>
            {% endif %}
        </div>
        
        <div class="form-group">
            <label for="{{ form.profile_image.id_for_label }}">{% trans 'Profile Image (Optional)' %}</label>
            {{ form.profile_image }}
            <p class="muted-text" style="font-size: 0.875rem; margin-top: 0.5rem;">
                {% trans 'Take a quick photo or upload an existing image.' %}
                {% if user.profile_image %}
                    <br><small>{% trans 'Leave empty to use your profile image:' %} <img src="{{ user.profile_image.url }}" alt="{% trans 'Profile image' %}" style="max-width: 100px; vertical-align: middle; margin-left: 0.5rem;"></small>
                {% endif %}
            </p>
            {% if form.profile_image.errors %}
                <div class="error">{{ form.profile_image.errors }}</div>
            {% endif %}
        </div>
        
        <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
            <button type="submit" class="btn btn-primary">{% trans 'Submit Application' %}</button>
            {% audio_player_static_ui "button_submit_application" "label" %}
            <a href="{% url 'jobs:detail' job.pk %}" class="btn">{% trans 'Cancel' %}</a>
            {% audio_player_static_ui "button_cancel" "label" %}
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'audio/audio-recorder.js' %}"></script>
<script>
    // Initialize audio recording for profile audio
    if (document.querySelector('[data-audio-recording][data-file-input-id="{{ form.profile_audio.id_for_label }}"]')) {
        const audioSection = document.querySelector('[data-audio-recording][data-file-input-id="{{ form.profile_audio.id_for_label }}"]');
        // Audio recording will be initialized by audio-recorder.js
    }
</script>
{% endblock %}
