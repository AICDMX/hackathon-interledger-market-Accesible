{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans 'My Jobs' %} - {{ block.super }}{% endblock %}

{% block content %}
{% load audio_tags %}
{% include 'components/static_title_with_audio.html' with title_text="My Jobs" slug="page_my_jobs" heading_tag="h1" %}

<!-- Applications Section -->
{% if applications %}
    {% include 'components/static_title_with_audio.html' with title_text="My Applications" slug="section_my_applications" heading_tag="h2" %}
    <div role="list" aria-label="{% trans 'Job applications' %}" style="margin-bottom: 2rem;">
        {% for application in applications %}
            <article class="card" role="listitem" style="margin-bottom: 1.5rem; border-left: 4px solid {% if application.status == 'selected' %}#10b981{% elif application.status == 'rejected' %}#ef4444{% else %}#f59e0b{% endif %};">
                {% include 'components/title_with_audio.html' with title=application.job.title content_object=application.job field_name="title" heading_tag="h3" link_url_name="jobs:detail" link_url_arg=application.job.pk %}
                
                <div style="margin: 1rem 0;">
                    <p><strong>{% trans 'Funder' %}:</strong> {{ application.job.funder.get_display_name }}</p>
                    <p><strong>{% trans 'Budget' %}:</strong> {{ application.job.budget }} pesos</p>
                    <p><strong>{% trans 'Applied' %}:</strong> {{ application.created_at|date:"F d, Y" }}</p>
                </div>
                
                <!-- Application Status -->
                <div style="background-color: #f8f9fa; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0;">
                    <p><strong>{% trans 'Application Status' %}:</strong> 
                        <span style="padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-weight: 600;
                            {% if application.status == 'selected' %}background-color: #10b981; color: white;
                            {% elif application.status == 'rejected' %}background-color: #ef4444; color: white;
                            {% else %}background-color: #f59e0b; color: white;{% endif %}">
                            {{ application.get_status_display }}
                        </span>
                    </p>
                    
                    <p><strong>{% trans 'Job Status' %}:</strong> 
                        <span style="padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-weight: 600;
                            {% if application.job.status == 'complete' %}background-color: #27ae60; color: white;
                            {% elif application.job.status == 'reviewing' %}background-color: #f39c12; color: white;
                            {% elif application.job.status == 'submitting' %}background-color: #3498db; color: white;
                            {% elif application.job.status == 'selecting' %}background-color: #9b59b6; color: white;
                            {% elif application.job.status == 'recruiting' %}background-color: #3498db; color: white;
                            {% else %}background-color: #95a5a6; color: white;{% endif %}">
                            {{ application.job.get_status_display }}
                        </span>
                    </p>
                    
                    {% if application.status == 'selected' and application.job.status == 'submitting' %}
                        <div style="background-color: #fff3cd; padding: 0.75rem; border-radius: 0.5rem; margin-top: 0.5rem; border-left: 4px solid #ffc107;">
                            <p style="margin: 0; font-weight: 600; color: #856404;">
                                ? {% trans 'Action Required: You have been selected! Submit your work for this job.' %}
                            </p>
                        </div>
                    {% elif application.status == 'pending' %}
                        <div style="background-color: #d1ecf1; padding: 0.75rem; border-radius: 0.5rem; margin-top: 0.5rem; border-left: 4px solid #17a2b8;">
                            <p style="margin: 0; color: #0c5460;">
                                ? {% trans 'Your application is pending review by the job owner.' %}
                            </p>
                        </div>
                    {% elif application.status == 'rejected' %}
                        <div style="background-color: #f8d7da; padding: 0.75rem; border-radius: 0.5rem; margin-top: 0.5rem; border-left: 4px solid #dc3545;">
                            <p style="margin: 0; color: #721c24;">
                                ? {% trans 'Your application was not selected for this job.' %}
                            </p>
                        </div>
                    {% endif %}
                </div>
                
                {% if application.profile_note %}
                    <div style="margin-top: 1rem;">
                        <p><strong>{% trans 'Your Application Note' %}:</strong> {{ application.profile_note|linebreaks }}</p>
                    </div>
                {% endif %}
                
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 1rem;">
                    <a href="{% url 'jobs:detail' application.job.pk %}" class="btn btn-primary">{% trans 'View Job' %}</a>
                    {% audio_player_static_ui "button_view_job" "label" %}
                    {% if application.status == 'selected' and application.job.status == 'submitting' %}
                        <a href="{% url 'jobs:submit' application.job.pk %}" class="btn btn-success">{% trans 'Submit Work' %}</a>
                        {% audio_player_static_ui "button_submit_work" "label" %}
                    {% endif %}
                </div>
            </article>
        {% endfor %}
    </div>
{% endif %}

<!-- Accepted Submissions Section -->
{% if accepted_submissions %}
    {% include 'components/static_title_with_audio.html' with title_text="Accepted Jobs" slug="section_accepted_jobs" heading_tag="h2" %}
    <div role="list" aria-label="{% trans 'Accepted job submissions' %}">
        {% for submission in accepted_submissions %}
            <article class="card" role="listitem" style="margin-bottom: 1.5rem;">
                {% include 'components/title_with_audio.html' with title=submission.job.title content_object=submission.job field_name="title" heading_tag="h2" link_url_name="jobs:detail" link_url_arg=submission.job.pk %}
                
                <div style="margin: 1rem 0;">
                    <p><strong>{% trans 'Funder' %}:</strong> {{ submission.job.funder.get_display_name }}</p>
                    <p><strong>{% trans 'Budget' %}:</strong> {{ submission.job.budget }} pesos</p>
                    <p><strong>{% trans 'Accepted' %}:</strong> {{ submission.created_at|date:"F d, Y" }}</p>
                </div>
                
                <!-- Status Information -->
                <div style="background-color: #f8f9fa; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; border-left: 4px solid #3498db;">
                    <h3 style="margin-top: 0; font-size: 1.1rem;">{% trans 'Status' %}</h3>
                    
                    <!-- Job Status -->
                    <p><strong>{% trans 'Job Status' %}:</strong> 
                        <span style="padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-weight: 600;
                            {% if submission.job.status == 'complete' %}background-color: #27ae60; color: white;
                            {% elif submission.job.status == 'reviewing' %}background-color: #f39c12; color: white;
                            {% elif submission.job.status == 'submitting' %}background-color: #3498db; color: white;
                            {% else %}background-color: #95a5a6; color: white;{% endif %}">
                            {{ submission.job.get_status_display }}
                        </span>
                    </p>
                    
                    <!-- Work Completion Status -->
                    <p><strong>{% trans 'Your Work' %}:</strong> 
                        {% if submission.is_complete %}
                            <span style="color: #27ae60; font-weight: 600;">? {% trans 'Completed' %}</span>
                            {% if submission.completed_at %}
                                ({{ submission.completed_at|date:"F d, Y" }})
                            {% endif %}
                        {% elif submission.job.status == 'submitting' %}
                            <span style="color: #e74c3c; font-weight: 600;">? {% trans 'Not Submitted Yet' %}</span>
                            <br><small style="color: #7f8c8d;">{% trans 'You need to submit your work for this job.' %}</small>
                        {% else %}
                            <span style="color: #f39c12; font-weight: 600;">? {% trans 'In Progress' %}</span>
                        {% endif %}
                    </p>
                    
                    <!-- Payment Status -->
                    <p><strong>{% trans 'Payment Status' %}:</strong> 
                        {% if submission.job.contract_completed %}
                            <span style="color: #27ae60; font-weight: 600;">? {% trans 'Contract Completed - Payment Released' %}</span>
                        {% elif submission.is_complete and submission.job.status == 'reviewing' %}
                            <span style="color: #f39c12; font-weight: 600;">? {% trans 'Waiting for Contract Completion' %}</span>
                            <br><small style="color: #7f8c8d;">{% trans 'Job owner needs to complete the contract to release payment.' %}</small>
                        {% elif submission.job.status == 'complete' %}
                            <span style="color: #27ae60; font-weight: 600;">? {% trans 'Job Complete' %}</span>
                        {% else %}
                            <span style="color: #95a5a6; font-weight: 600;">? {% trans 'Payment Pending' %}</span>
                        {% endif %}
                    </p>
                </div>
                
                <!-- Next Action Needed -->
                {% if submission.job.status == 'submitting' and not submission.is_complete %}
                    <div style="background-color: #fff3cd; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; border-left: 4px solid #ffc107;">
                        <p style="margin: 0; font-weight: 600; color: #856404;">
                            ? {% trans 'Action Required: Submit your work for this job' %}
                        </p>
                    </div>
                {% elif submission.status == 'accepted' and submission.job.status == 'reviewing' and not submission.job.contract_completed %}
                    <div style="background-color: #d1ecf1; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; border-left: 4px solid #17a2b8;">
                        <p style="margin: 0; font-weight: 600; color: #0c5460;">
                            ? {% trans 'Waiting: Job owner is reviewing your work and will complete the contract to release payment.' %}
                        </p>
                    </div>
                {% endif %}
                
                {% if submission.note %}
                    <div style="margin-top: 1rem;">
                        <p><strong>{% trans 'Your Note' %}:</strong> {{ submission.note }}</p>
                    </div>
                {% endif %}
                {% if submission.text_content %}
                    <div style="margin-top:1rem;">
                        <p><strong>{% trans 'Text Content' %}:</strong></p>
                        <div style="background-color: #f5f5f5; padding: 1rem; border-radius: 0.5rem; white-space: pre-wrap;">{{ submission.text_content }}</div>
                    </div>
                {% endif %}
                
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 1rem;">
                    <a href="{% url 'jobs:detail' submission.job.pk %}" class="btn btn-primary">{% trans 'View Job' %}</a>
                    {% audio_player_static_ui "button_view_job" "label" %}
                    {% if submission.job.status == 'submitting' and not submission.is_complete %}
                        <a href="{% url 'jobs:submit' submission.job.pk %}" class="btn btn-success">{% trans 'Submit Work' %}</a>
                        {% audio_player_static_ui "button_submit_work" "label" %}
                    {% endif %}
                </div>
            </article>
        {% endfor %}
    </div>
{% endif %}

<!-- Empty State -->
{% if not applications and not accepted_submissions %}
    <div class="card">
        <p>{% trans 'You have not applied to any jobs yet.' %}</p>
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            <a href="{% url 'jobs:list' %}" class="btn btn-primary">{% trans 'Browse Available Jobs' %}</a>
            {% audio_player_static_ui "button_browse_available_jobs" "label" %}
        </div>
    </div>
{% endif %}
{% endblock %}
