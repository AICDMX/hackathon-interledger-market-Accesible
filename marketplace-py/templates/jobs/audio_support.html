{% extends 'base.html' %}
{% load i18n static %}

{% block title %}{{ opportunity.title }} - {{ block.super }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'audio/audio-contribution.css' %}">
{% endblock %}

{% block content %}
<section class="card" style="margin-bottom: 1.5rem;">
    <h1 style="margin-bottom: 0.5rem;">{{ opportunity.title }}</h1>
    <p style="margin-bottom: 1rem;">{{ opportunity.description_es }}</p>
    <p><strong>{% trans 'Target Language' %}:</strong> {{ opportunity.language_code }}</p>
</section>

<section class="card" id="funding" style="margin-bottom: 1.5rem;">
    <h2 style="margin-bottom: 0.5rem;">{% trans 'Fondear esta grabación' %}</h2>
    {% if opportunity.needs_funding %}
        <p>{% blocktrans with amount=community_fund_amount %}Puedes comprometer  {{ amount }} pesos para que grabemos este audio.{% endblocktrans %}</p>
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="pledge_funds">
            <button type="submit" class="btn btn-primary">
                {% blocktrans with amount=community_fund_amount %}Fondear con {{ amount }} pesos{% endblocktrans %}
            </button>
            <p class="muted-text" style="margin-top: 0.5rem;">
                {% trans 'Aún estamos conectando los pagos. Guardaremos tu intención para avisarte cuando esté listo.' %}
            </p>
        </form>
    {% else %}
        <p class="muted-text">
            {% trans 'Esta sección ya está financiada. Puedes ayudar subiendo audio.' %}
        </p>
    {% endif %}
</section>

<section class="card" id="upload-audio">
    <h2 style="margin-bottom: 0.5rem;">{% trans 'Subir audio comunitario' %}</h2>
    <p>{% trans 'Graba un mensaje corto (menos de 30 segundos) explicando el botón y súbelo aquí. Puedes grabar directamente desde tu navegador o subir un archivo de audio.' %}</p>
    
    <div class="card bg-info" style="margin-bottom: 1rem; padding: 0.75rem;">
        <p style="margin: 0;"><strong>{% trans 'Idioma requerido' %}:</strong> {{ opportunity.language_code }}</p>
        <p class="muted-text" style="margin: 0.25rem 0 0 0; font-size: 0.875rem;">
            {% trans 'Este audio debe estar en el idioma especificado arriba.' %}
        </p>
    </div>

    <div id="audio-contribution-form" 
         data-audio-contribution
         data-target-slug="{{ opportunity.slug }}"
         data-language-code="{{ opportunity.language_code }}"
         data-upload-url="{% url 'audio:upload_contribution' %}"
         data-max-duration="30000"
         data-compression-bitrate="192000">
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="action" value="upload_audio">
            <input type="hidden" name="language_code" value="{{ opportunity.language_code }}">
            <div class="form-group">
                <label for="{{ contribution_form.file.id_for_label }}">{{ contribution_form.file.label }}</label>
                <p class="muted-text" style="font-size: 0.875rem; margin-top: 0.25rem;">
                    {% trans 'O graba directamente usando los controles de arriba' %}
                </p>
                {{ contribution_form.file }}
                {% if contribution_form.file.errors %}
                    <div class="form-error">{{ contribution_form.file.errors }}</div>
                {% endif %}
            </div>
            <div class="form-group">
                <label for="{{ contribution_form.notes.id_for_label }}">{{ contribution_form.notes.label }}</label>
                {{ contribution_form.notes }}
                {% if contribution_form.notes.errors %}
                    <div class="form-error">{{ contribution_form.notes.errors }}</div>
                {% endif %}
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <button type="submit" class="btn btn-primary">{% trans 'Enviar audio' %}</button>
                {% audio_player_static_ui "button_send_audio" "label" %}
            </div>
        </form>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="{% static 'audio/audio-recorder.js' %}"></script>
<script src="{% static 'audio/audio-contribution-ui.js' %}"></script>
{% endblock %}
